<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />



<title>Introduction aux outils d’analyse de données et à R</title>

<script src="index_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script src="index_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<script src="index_files/navigation-1.1/tabsets.js"></script>
<script src="index_files/navigation-1.1/codefolding.js"></script>
<link href="index_files/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
<script src="index_files/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
<link href="index_files/readthedown-0.1/readthedown.css" rel="stylesheet" />
<script src="index_files/readthedown-0.1/readthedown.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; background-color: #dddddd; }
td.sourceCode { padding-left: 5px; }
code > span.kw { font-weight: bold; } /* Keyword */
code > span.dt { color: #800000; } /* DataType */
code > span.dv { color: #0000ff; } /* DecVal */
code > span.bn { color: #0000ff; } /* BaseN */
code > span.fl { color: #800080; } /* Float */
code > span.ch { color: #ff00ff; } /* Char */
code > span.st { color: #dd0000; } /* String */
code > span.co { color: #808080; font-style: italic; } /* Comment */
code > span.al { color: #00ff00; font-weight: bold; } /* Alert */
code > span.fu { color: #000080; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #ff0000; font-weight: bold; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #ff00ff; } /* SpecialChar */
code > span.vs { color: #dd0000; } /* VerbatimString */
code > span.ss { color: #dd0000; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { font-weight: bold; } /* Preprocessor */
code > span.at { } /* Attribute */
code > span.do { color: #808080; font-style: italic; } /* Documentation */
code > span.an { color: #808080; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #808080; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #808080; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>


<div id="content" data-toggle="wy-nav-shift">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->

<nav id="nav-top" role="navigation" aria-label="top navigation">
    <a role="button" href="#" data-toggle="wy-nav-top"><span class="glyphicon glyphicon-menu-hamburger"></span></a>
</nav>


<div id="header">
<h1 class="title">Introduction aux outils d’analyse de données et à R</h1>
</div>


<div id="table-of-contents">
    <h2><a href="#content">Introduction aux outils d’analyse de données et à R</a></h2>
    <div id="text-table-of-contents">
      <ul>
      <li><a href="#preambule"><span class="toc-section-number">1</span> Préambule</a></li>
      <li><a href="#les-materiaux-necessaires-pour-cette-formation"><span class="toc-section-number">2</span> Les matériaux nécessaires pour cette formation</a></li>
      <li><a href="#les-etapes-de-la-formation"><span class="toc-section-number">3</span> Les étapes de la formation :</a><ul>
      <li><a href="#premiere-demo"><span class="toc-section-number">3.1</span> Première démo :</a></li>
      <li><a href="#la-donnee"><span class="toc-section-number">3.2</span> La donnée ?</a></li>
      <li><a href="#quest-ce-que-lopen-data"><span class="toc-section-number">3.3</span> Qu’est ce que l’open data ?</a></li>
      <li><a href="#quest-ce-que-le-big-data"><span class="toc-section-number">3.4</span> Qu’est ce que le big data ?</a></li>
      <li><a href="#quest-ce-que-le-linked-data"><span class="toc-section-number">3.5</span> Qu’est ce que le linked data ?</a></li>
      <li><a href="#pourquoi-sinteresser-a-lanalyse-des-donnees"><span class="toc-section-number">3.6</span> Pourquoi s’intéresser à l’analyse des données ?</a></li>
      <li><a href="#et-vous-pourquoi-ca-vous-interesse"><span class="toc-section-number">3.7</span> Et vous pourquoi ça vous intéresse ?</a></li>
      <li><a href="#lecosysteme-des-donnees"><span class="toc-section-number">3.8</span> L’écosystème des données</a></li>
      <li><a href="#les-outils"><span class="toc-section-number">3.9</span> Les outils</a></li>
      <li><a href="#les-infrastructures"><span class="toc-section-number">3.10</span> Les infrastructures</a></li>
      <li><a href="#one-tool-to-rule-them-all"><span class="toc-section-number">3.11</span> One tool to rule them all</a></li>
      <li><a href="#cest-quoi-tes-donnees"><span class="toc-section-number">3.12</span> C’est quoi tes données?</a></li>
      </ul></li>
      <li><a href="#installation-de-r"><span class="toc-section-number">4</span> Installation de R</a><ul>
      <li><a href="#installation-du-tidyverse"><span class="toc-section-number">4.1</span> Installation du tidyverse</a></li>
      <li><a href="#lancement-du-tidyverse"><span class="toc-section-number">4.2</span> Lancement du tidyverse :</a></li>
      </ul></li>
      <li><a href="#vocabulaire-de-r"><span class="toc-section-number">5</span> Vocabulaire de R</a></li>
      <li><a href="#commandes-de-r"><span class="toc-section-number">6</span> Commandes de R</a></li>
      <li><a href="#interface-de-r-studio"><span class="toc-section-number">7</span> Interface de R Studio</a></li>
      <li><a href="#scripts-et-projets-sur-r"><span class="toc-section-number">8</span> Scripts et projets sur R</a><ul>
      <li><a href="#creer-un-notebook"><span class="toc-section-number">8.1</span> Créer un Notebook</a></li>
      <li><a href="#creer-un-r-markdown"><span class="toc-section-number">8.2</span> Créer un R Markdown</a></li>
      <li><a href="#creation-dun-script"><span class="toc-section-number">8.3</span> Création d’un script</a></li>
      </ul></li>
      <li><a href="#importer-des-donnees"><span class="toc-section-number">9</span> Importer des données</a><ul>
      <li><a href="#sur-le-format-csv"><span class="toc-section-number">9.1</span> Sur le format CSV</a></li>
      <li><a href="#avec-linterface-graphique"><span class="toc-section-number">9.2</span> Avec l’interface graphique</a></li>
      <li><a href="#en-ligne-de-commandes"><span class="toc-section-number">9.3</span> En ligne de commandes</a></li>
      </ul></li>
      <li><a href="#afficher-les-donnees"><span class="toc-section-number">10</span> Afficher les données</a></li>
      <li><a href="#sauvegarder-des-donnees"><span class="toc-section-number">11</span> Sauvegarder des données ?</a></li>
      <li><a href="#nettoyer-les-donnees---tidy-data"><span class="toc-section-number">12</span> Nettoyer les données - tidy data</a><ul>
      <li><a href="#les-principes"><span class="toc-section-number">12.1</span> Les principes</a></li>
      <li><a href="#cas-pratique"><span class="toc-section-number">12.2</span> Cas pratique</a></li>
      <li><a href="#preparer-des-tidy-data"><span class="toc-section-number">12.3</span> Préparer des tidy data</a></li>
      </ul></li>
      <li><a href="#transformer-les-donnees"><span class="toc-section-number">13</span> Transformer les données</a><ul>
      <li><a href="#un-autre-exemple"><span class="toc-section-number">13.1</span> Un autre exemple</a></li>
      </ul></li>
      <li><a href="#pivoter-gather-et-spread-du-package-tidyr"><span class="toc-section-number">14</span> Pivoter (<code>gather</code> et <code>spread</code>, du package <code>tidyr</code>)</a><ul>
      <li><a href="#cas-des-bureaux-de-votes-a-paris"><span class="toc-section-number">14.1</span> Cas des bureaux de votes à Paris</a></li>
      <li><a href="#exercice-avec-des-donnees-electorales"><span class="toc-section-number">14.2</span> Exercice avec des données électorales</a></li>
      </ul></li>
      <li><a href="#quelques-autres-fonctions-utiles"><span class="toc-section-number">15</span> Quelques autres fonctions utiles</a><ul>
      <li><a href="#filter-les-donnees"><span class="toc-section-number">15.1</span> Filter les données</a></li>
      </ul></li>
      <li><a href="#agreger-un-jeu-de-donnees-group_by-summarise"><span class="toc-section-number">16</span> Agréger un jeu de données (<code>group_by</code> + <code>summarise</code>)</a></li>
      <li><a href="#fusionner-left_join"><span class="toc-section-number">17</span> Fusionner (<code>left_join</code>)</a></li>
      </ul>
    </div>
</div>

<div id="main">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-80486908-1', 'auto');
  ga('send', 'pageview');

</script>
<div id="preambule" class="section level1">
<h1><span class="header-section-number">1</span> Préambule</h1>
<p>Cette documentation est le fruit d’un travail collaboratif, réalisé par les participants à <a href="http://www.datactivi.st/formation.html">la formation organisée par Open Data France et datactivi.st</a>. Un grand merci à eux !</p>
<p>Elle accompagne les supports de formation suivants :</p>
<ul>
<li>les <a href="./jour1.html">slides de la première journée</a></li>
<li>les <a href="./jour2.html">slides de la deuxième journée</a></li>
<li>les <a href="./jour3.html">slides de la troisième journée</a></li>
<li>le <a href="https://github.com/datactivist/IntroR_ODF/blob/master/script.R">script R</a> reprenant les principales manipulations de données effectuées durant ces trois jours.</li>
</ul>
<p>La documentation correspondant au module suivant, “Utiliser R pour l’analyse et la visualisation de données”, peut être <a href="./index2.html">retrouvée ici</a>.</p>
<p>L’ensemble de ces matériaux peut être retrouvé sur le <a href="https://github.com/datactivist/IntroR_ODF">repo github dédié</a>.</p>
<p>L’ensemble de ces matériaux est placé, sauf mention contraire, sous <a href="https://creativecommons.org/licenses/by-sa/4.0/">licence Creative Commons CC-BY-SA</a>.</p>
</div>
<div id="les-materiaux-necessaires-pour-cette-formation" class="section level1">
<h1><span class="header-section-number">2</span> Les matériaux nécessaires pour cette formation</h1>
<ul>
<li>Une bonne connexion internet pour tous</li>
<li>Un ordinateur par personne</li>
<li>Toute la documentation de la formation : www.github.com/datactivist/introR_ODF</li>
</ul>
<p>Pour le formateur :</p>
<ul>
<li>préparer les démo</li>
</ul>
</div>
<div id="les-etapes-de-la-formation" class="section level1">
<h1><span class="header-section-number">3</span> Les étapes de la formation :</h1>
<div id="premiere-demo" class="section level2">
<h2><span class="header-section-number">3.1</span> Première démo :</h2>
<p>Les participants renseignent le formulaire (<a href="http://frama.link/formationR" class="uri">http://frama.link/formationR</a>) qui demande des informations basiques sur les participants. Ce formulaire sert de démonstration des usages potentiels de R.</p>
<p>Comment connecter un simple formulaire Google Form, ses données récoltées dans un tableur et les visualiser très simplement avec des petits modules de graphes ou de cartes sur une page HTML construite automatiquement.</p>
<p>Le formateur a créé préalablement <a href="https://github.com/datactivist/IntroR_ODF/blob/master/dashboard.Rmd">un code R</a> qui permet de visualiser en temps réel <a href="./dashboard.html">un dashboard</a> qui présente les résultats.</p>
<p>La force de R, c’est de permettre d’utiliser un code simple et concis (70 lignes dans ce cas). Il faut une heure à une heure et demi pour l’écrire.</p>
</div>
<div id="la-donnee" class="section level2">
<h2><span class="header-section-number">3.2</span> La donnée ?</h2>
<p>Selon vous, qu’est ce qu’une donnée ?</p>
<ul>
<li>Quantification</li>
<li>Une couleur c’est une donnée</li>
<li>Une information pas forcément lisible immédiatement, lisible par un logiciel</li>
<li>Lisible par un humain</li>
<li>Textuel ou numérique</li>
<li>Une information structurée</li>
<li>Quantification / Qualification d’un phénomène</li>
<li><p>La loi (CRPA) : donnée, lisible par machine</p></li>
<li>Définition inclusive ==/== restrictive</li>
<li><p>« Ce qui n’est pas considéré comme une donnée est une donnée »</p></li>
</ul>
<p>Comment ouvrir des données et se demander lesquelles sont à ouvrir ou pas?</p>
<p>Ile de France: Les agents doivent se justifier en cas d’un refus d’ouverture de données.</p>
<p>Avec la Loi pour une République Numérique, cette question de ce qu’est une donnée va devenir de plus en plus importante.</p>
<p>R est plus ou moins bien adapté pour traiter certains types/formats, il va falloir donc savoir à l’avance lesquelles vont représenter plus de travail ou pas à traiter avec R</p>
<blockquote>
<p><a href="https://mitpress.mit.edu/books/raw-data-oxymoron">« Raw data is an oxymoron »</a> / les données brutes sont un oxymore.</p>
</blockquote>
<p>RUSSELL ACKOFF - Théoricien des systèmes &amp; cybernétique</p>
<p>« Il faut que l’information circule pour qu’elle ne disparaisse pas. » Sa vision: Les données seraient brutes par essence. Si on ouvre les données, on va créer plus de savoir et plus de sagesse.</p>
<p>Notion de données, 2 dimensions :</p>
<ul>
<li>pas de condition de véracité (Rosenberg, 2013)</li>
<li>point de départ de nouveaux réseaux sociotechniques</li>
</ul>
<p>Les données sont obtenues : « Décidément, on ne devrait jamais parler de “données”, mais toujours d’“obtenues”. » Bruno Latour, 1993</p>
<p>En statistiques, la définition de la donnée varie un peu selon le cadre conceptuel et philosophique. D’un côté, les fréquentistes, pour qui on peut tester la véracité d’énoncés au moyen d’expériences et de tests statistiques. Chaque épreuve se déroule indépendamment des croyances ou connaissances préalables. Pour les bayésiens, au contraire, il y a beaucoup plus de doutes à avoir vis-à-vis de l’objectivation du monde, c’est une approche beaucoup moins naïve qui porte sur la quantification des croyances sur le monde, qui intègre les croyances ou connaissances qu’on a déjà. Dans ce contexte, les données permettent de mettre à jour ces croyances mais n’en sont pas radicalement distinctes.</p>
</div>
<div id="quest-ce-que-lopen-data" class="section level2">
<h2><span class="header-section-number">3.3</span> Qu’est ce que l’open data ?</h2>
<p>Voir la définition de l’<a href="http://opendefinition.org/od/1.1/fr/">Open Definition</a></p>
<p>OD : données réutilisables dans des formats techniques et juridiques (2 licences : Licence Ouverte (citer la source - BY) et ODbL (citer la source + partager à l’identique : BY - SA)).</p>
<p>Les données sont généralement gratuites.</p>
<p>Réutilisation par tous, pour toutes formes d’usages.</p>
<p>Lisibles par machines.</p>
<p>Principes:</p>
<ul>
<li>Données accessibles</li>
<li>Format ouvert</li>
<li>Usage: attribuer à la source et redistribuer à l’identique</li>
</ul>
</div>
<div id="quest-ce-que-le-big-data" class="section level2">
<h2><span class="header-section-number">3.4</span> Qu’est ce que le big data ?</h2>
<p><a href="http://gph.is/29aDePB"><img src="http://i.giphy.com/TnuKaZxbMbHhK.gif" alt="What is big data anyway ?" /></a></p>
<p>Big Data : <a href="http://www.journaldunet.com/solutions/expert/51696/les-3-v-du-big-data---volume--vitesse-et-variete.shtml">règle des 3 V</a> (Vélocité, Volume, Variété) : hors des GAFA, on rencontre rarement des données massives qui respectent ces trois critères. Voir <a href="http://www.cairn.info/revue-informations-sociales-2015-5-page-26.htm">cet article de Samuel Goëta</a> qui permet de bien distinguer open data et big data. Ces données ne sont en général pas ouvertes, c’est un trésor bien gardé des organisations.</p>
</div>
<div id="quest-ce-que-le-linked-data" class="section level2">
<h2><span class="header-section-number">3.5</span> Qu’est ce que le linked data ?</h2>
<p>Web Sémantique proposé par Tim Berners-Lee (4ème et 5ème étoiles du <a href="http://5stardata.info/en/">modèle 5* de T. Berners-Lee</a>). Données liées, Données décrites dans des vocabulaires, des nomenclatures. Encore considéré comme une utopie, le Linked Data demeure malgré tout un objectif qualitatif intéressant</p>
<p>Un outil intéressant pour se rappeler des 5 * : <a href="http://www.cafepress.com/w3c_shop.597992118">le mug</a> !</p>
</div>
<div id="pourquoi-sinteresser-a-lanalyse-des-donnees" class="section level2">
<h2><span class="header-section-number">3.6</span> Pourquoi s’intéresser à l’analyse des données ?</h2>
<p>La maîtrise de l’information est un élément essentiel du rapport au pouvoir (empowerment, donnée de capacités d’action)</p>
<ul>
<li>Professionnellement</li>
<li>Personnellement, mouvement du <a href="http://mesinfos.fing.org/">self data</a> : données pour reprise en main de certaines parties de sa vie.</li>
</ul>
<p><a href="http://mesinfos.fing.org/selfdata/"><img src="img/image_domaine_usages.png" /></a></p>
<ul>
<li>Littératie de donnée</li>
<li>En tant que citoyen, déconstruire les algorithmes et se réapproprier les données qui servent à la décision publique</li>
</ul>
<p>Les données ne signifient rien à l’état brut. C’est un modèle qui permet de les interpréter : on fait des hypothèses sur le rapport des données avec la réalité et on donne du sens aux données pour confirmer/infirmer ce modèle.</p>
<div class="figure">
<img src="http://i.giphy.com/J14dxhoJLWlI4.gif" alt="fatal experience - http://gph.is/29hJuIt" />
<p class="caption">fatal experience - <a href="http://gph.is/29hJuIt" class="uri">http://gph.is/29hJuIt</a></p>
</div>
<p>Tout modèle vient avec des postulats. Il y a toujours un modèle. Quand il n’y en a pas, il est implicite.</p>
<p>Il faut donc expliciter nos modèles. Ex. de la taille : si je fais la moyenne, il faut que la distribution soit unimodale (il y a une seule valeur maximale). Si on fait la moyenne des tailles dans cette salle, c’est bimodal puisqu’il y a deux distributions différentes de la taille : les hommes et les femmes (la courbe de taille prendra la forme d’un chapeau mou avec 2 pics). La moyenne n’a aucun sens dans ce cas, ne correspond pas à une valeur interprétable. Dans ce contexte, calculer la moyenne n’a pas d’intérêt, il faut expliciter son modèle et l’adapter aux cas. La moyenne est un indicateur adapté lorsque la distribution est à peu près normale (en courbe de Gauss).</p>
<p>S’initier à l’analyse de données, c’est apprendre à expliciter ses modèles, formuler les hypothèses sous-jacentes, les tester. Les aller-retours entre visualisations et modèle permettent de mieux préciser sa démarche. Référence : <a href="https://fr.wikipedia.org/wiki/Edward_Tufte">Edward Tufte</a></p>
<p>In fine, il s’agit d’appréhender ses données de manière moins naïve.</p>
<p>Le workflow de l’analyse de données :</p>
<p><a href="http://r4ds.had.co.nz/explore-intro.html"><img src="img/data-science-model.png" /></a></p>
<p>En amont, import et nettoyage (phases souvent très consommatrices en temps); en aval, communication.</p>
<p>Importer -&gt; Nettoyer -&gt; Transformer -&gt; Visualiser -&gt; Modéliser -&gt; Communiquer</p>
<p>De Transformer à Modéliser : peut être une boucle jusqu’à obtention d’un résultat satisfaisant.</p>
</div>
<div id="et-vous-pourquoi-ca-vous-interesse" class="section level2">
<h2><span class="header-section-number">3.7</span> Et vous pourquoi ça vous intéresse ?</h2>
<p>Eléments de réponse fournis :</p>
<ul>
<li>Se doter de méthodes / outils de nettoyage et transformation</li>
<li>Mieux faire parler des données brutes, utiliser davantage nos propres données</li>
<li>Élargir la palette d’outils d’analyse de données</li>
<li>Trouver une manière de rassembler des méthodes ou outils aujourd’hui utilisés par des services différents</li>
<li>Faciliter les croisements de données</li>
<li>Coordonner transversalement des personnes qui utilisent déjà des données (BI, SIG, …)</li>
</ul>
<p>R : outil fonctionnant en ligne de commandes -&gt; on documente ce qu’on fait, ce qui facilite la reproductibilité des différentes composantes du workflow ci-dessus (gain en efficacité).</p>
</div>
<div id="lecosysteme-des-donnees" class="section level2">
<h2><span class="header-section-number">3.8</span> L’écosystème des données</h2>
<p>Outils déjà utilisés par les participants :</p>
<ul>
<li>Excel / Calc / tableur classique</li>
<li>SPSS, SPAD</li>
<li>Tableau</li>
<li>BO</li>
<li>Open Refine (utilisation pour du nettoyage de données ou du géocodage) : www.openrefine.org</li>
<li>CartoDB (visualisation)</li>
<li>ESRI, QGis, MapInfo (carto)</li>
</ul>
<p>Formats de données :</p>
<div class="figure">
<img src="http://i.giphy.com/jEEYJO9EgU5ig.gif" alt="Ciel mon tableur ! - http://gph.is/29aFBC1" />
<p class="caption">Ciel mon tableur ! - <a href="http://gph.is/29aFBC1" class="uri">http://gph.is/29aFBC1</a></p>
</div>
<ul>
<li>tabulaires (voir <a href="https://cran.r-project.org/web/packages/rio/vignettes/rio.html">RIO (R Input Output)</a>)</li>
<li>Excel / tableurs</li>
<li>formats texte (csv, tsv, csvy, psv, fwf) : ont l’avantage d’être publiquement documentés et relativement facilement exploitables par des machines. Moins facile à lire pour les humains</li>
<li>Datapackages : format standardisé proposé par OpenKnowledge (csv avec métadonnées en JSON pour le tabulaire), mais encore peu répandu (quelques usages significatifs sur des thématiques ciblées comme les marchés publics)</li>
<li>feather : format d’échange entre R et Python par ex. Avantage : lecture/écriture disque très rapide. Très prometteur lorsqu’il y a des échanges de gros volumes de données entre plusieurs langages</li>
<li>formats propriétaires dans le domaine des statistiques :
<ul>
<li>.dta</li>
<li>.sav, .por</li>
<li>.dbf (attention, versions incompatibles entre elles)</li>
<li>.sas7bdat, .xpt</li>
<li>…</li>
</ul></li>
<li>Formats plus exotiques :
<ul>
<li>XML</li>
<li>HTML</li>
<li>JSON (la bascule vers des données tabulaires n’est pas triviale)</li>
<li>YAML (souvent utilisé pour stocker des méta-données)</li>
<li>…</li>
</ul></li>
<li>Formats spécialisés
<ul>
<li>Exemple des données spatiales :
<ul>
<li>GDAL et sa version R (<a href="http://rgdal.sourceforge.net/">RGDAL</a> : gère 132 formats)</li>
<li>Shapefile (format propriétaire qui s’est imposé comme le standard malgré ses nombreux défauts : pas très bien documenté avec des limitations qui nuisent à l’intelligibilité)</li>
<li>GeoJSON : format ouvert, texte</li>
<li>topojson : format de données spatiales topologiques (intéressant à plusieurs points de vue)</li>
<li>kml (xml spécialisé en données spatiales)</li>
<li>mapinfo</li>
<li>formats raster (stockage plus économique que les formats vectoriels mais dégradation de la qualité lors des zooms)</li>
<li>tiles</li>
<li>…</li>
</ul></li>
</ul></li>
</ul>
<p>Bases de données :</p>
<ul>
<li>Surtout intéressantes sur de la donnée chaude (i.e. susceptible de changer souvent)</li>
<li>Bases relationnelles / SQL (orientées ligne, c’est-à-dire adaptées pour insérer, lire, mettre à jour des lignes de données) : leur performance est fortement corrélée à la manière dont les données sont indexées, ce qui est un inconvénient car il faut avoir très bien pensé son système et ses usages avant de le mettre en oeuvre
<ul>
<li>MySQL</li>
<li>SQLite (pour des volumes pas trop importants, bien adapté pour de l’électronique embarquée)</li>
<li>PostgresSQL : capacité de gestion spatiale intéressante (PostGIS) mais complexité d’administration</li>
<li>…</li>
</ul></li>
<li>Bases SQL orientées colonnes : elles sont optimisées pour lire des colonnes, adaptées pour des analyses globales sur l’ensemble du contenu d’une base
<ul>
<li>MonetDB, <a href="https://www.monetdb.org/blog/monetdblite-r">MonetDBLite</a> (utilisable dans R sans installation externe et performante, l’indexation s’effectuant à la volée)</li>
<li>…</li>
</ul></li>
<li>Bases NoSQL : bases qui ne reposent pas seulement sur une logique SQL ou tabulaire (a priori, on peut avoir différents types de données : fichiers, images, textes, etc.). Théoriquement, il n’est pas nécessaire de connaître le schéma de la table (possibilité de modifications du schéma de données en cours de route). Du coup, l’indexation est moins efficace que sur des bases SQL, ce qui amène des acteurs à mélanger des bases NoSQL et SQL pour répondre à ce souci
<ul>
<li>MongoDB</li>
<li>Cassandra</li>
<li>CouchDB</li>
<li>SimpleDB</li>
<li>BigTable</li>
<li>HBase</li>
<li>Neo4J (base orientée graphe : les enregistrements stockés sont connectés les uns aux autres)</li>
<li>Redis</li>
<li>…</li>
</ul></li>
</ul>
<p>Les API : moyen de communication entre 2 machines - <a href="https://fr.wikipedia.org/wiki/Interface_de_programmation" class="uri">https://fr.wikipedia.org/wiki/Interface_de_programmation</a></p>
<p>Beaucoup de formats de données et de types des bases de données, d’où de nombreux outils d’exploitation des données …</p>
</div>
<div id="les-outils" class="section level2">
<h2><span class="header-section-number">3.9</span> Les outils</h2>
<p>Ceux qu’on a l’habitude d’utiliser ou que tout le monde connaît :</p>
<ul>
<li>Excel, LibreOffice, un tableur quelconque
<ul>
<li>Inconvénients : se présentent comme des outils gérant des données tabulaires mais mélangent des éléments très hétérogènes, ce qui rend les données issues de ce type d’outils difficilement exploitables par des machines. Aujourd’hui, cela conduit à l’apparition <a href="http://comma-chameleon.io/">d’outils</a> qui gèrent réellement des données tabulaires avec des interfaces graphiques csv</li>
</ul></li>
</ul>
<p>Outils avec interface graphique (GUI)</p>
<ul>
<li>Sphinx</li>
<li>SPSS</li>
<li>SAS : qualité reconnue (outil préférentiel de l’INSEE jusqu’à présent; coûte très cher)</li>
<li>OpenRefine</li>
<li><a href="https://www.databasic.io/en/wtfcsv/">WTF CSV</a> : permet d’avoir une 1ère vision du contenu d’un fichier CSV sans entrer dans un outil comme R</li>
<li>Tableau : permet de faire de la belle dataviz, mais propriétaire</li>
</ul>
<p>Outils avec une interface en lignes de commande (CLI)</p>
<ul>
<li>Python</li>
<li>Julia (courbe très ascendante pour ce langage encore très jeune)</li>
<li>R</li>
<li>C/C++ (une tendance actuelle dans l’utilisation de R est d’écrire les algos les plus gourmands en C++)</li>
<li>Java</li>
<li>Javascript : langage interprété dont les utilisations se sont étendues</li>
<li>outils bash : outils qui peuvent demeurer performants mais très mals documentés et difficiles à utiliser</li>
</ul>
<p>Tous ces outils CLI s’interfacent très bien avec R.</p>
<p>Outils spécialisés. Ex: cas de la cartographie :</p>
<ul>
<li>QGis : lourd à mettre en oeuvre</li>
<li><a href="http://philcarto.free.fr/">PhilCarto</a> : permet de réaliser de la cartographie thématique. Mérite le coup d’oeil, mais mets des lunettes 80’s ;-). Propriétaire.</li>
<li>MapInfo</li>
<li>ArcGIS</li>
<li>Umap : bien adapté pour les débutants.</li>
<li>Leaflet : librairie Javascript permettant de faire de la cartographie (s’interface bien avec R)</li>
</ul>
</div>
<div id="les-infrastructures" class="section level2">
<h2><span class="header-section-number">3.10</span> Les infrastructures</h2>
<p>Celles qui se développent dans le Big Data (utilisent la parallélisation pour optimiser les traitements de données et distribuer les stockages de celles-ci) :</p>
<ul>
<li>Hadoop</li>
<li>Spark</li>
<li>H20</li>
<li>…</li>
</ul>
</div>
<div id="one-tool-to-rule-them-all" class="section level2">
<h2><span class="header-section-number">3.11</span> One tool to rule them all</h2>
<p>Un outil, R, pour aller visiter l’ensemble de ces univers. Initialement conçu pour la manipulation des données.</p>
<p>R prend la suite de S : langage de haut niveau (= proche d’un langage compréhensible par l’homme mais relativement inefficace en terme de performances)</p>
<p>S langage développé dans les Bell Labs. R a été développé à l’origine par des universitaires statisticiens, pour répondre à leurs besoins, sans restrictions de licences (-&gt; caractère libre) Le développement historique de R s’est opéré par l’intermédiaire des packages (décentralisés) développés autour du coeur du langage (qui est demeuré très stable depuis le départ). R est devenu leader incontesté dans le domaine des statistiques avec une forte communauté internationale. Au fil du temps, il est devenu un outil à vocation généraliste (dév. Web, machine learning, etc.). Par ailleurs, il permet d’interfacer de nombreux outils spécialisés (grâce à l’appel de librairies).</p>
<p>Énormément de ressources disponibles (souvent en anglais même si la communauté et les ressources françaises se développent). Une petite sélection :</p>
<ul>
<li>Un livre sur R : <a href="http://r4ds.had.co.nz">R for Data Science</a> de Garrett Grolemund et Hadley Wickham (rock star de R)</li>
<li>blogs : </li>
<li>des listes de diffusion thématiques</li>
<li>un site de Q/R communautaires : <a href="http://stackoverflow.com/tagged/r" class="uri">http://stackoverflow.com/tagged/r</a></li>
<li>twitter avec le hashtag #Rstats</li>
</ul>
<p>Une communauté <a href="https://rladies.org/">bienveillance avec les femmes</a>.</p>
<p>Une syntaxe de plus en plus facile</p>
<p><a href="https://rstudio.github.io/rstudioaddins/">Des progrès vers du GUI</a></p>
</div>
<div id="cest-quoi-tes-donnees" class="section level2">
<h2><span class="header-section-number">3.12</span> C’est quoi tes données?</h2>
<p>Les questions auxquelles il faut savoir répondre :</p>
<ul>
<li>domaine</li>
<li>format</li>
<li>taille</li>
<li>granularité</li>
<li>fraîcheur</li>
<li>quelle analyse veut-on en faire</li>
</ul>
</div>
</div>
<div id="installation-de-r" class="section level1">
<h1><span class="header-section-number">4</span> Installation de R</h1>
<ul>
<li><a href="https://cloud.r-project.org/">Installation de R</a></li>
<li>Sous windows télécharger <a href="https://cran.r-project.org/bin/windows/Rtools/">R Tools</a></li>
<li>Sous MacOS X il faut probablement <a href="https://github.com/kennethreitz/osx-gcc-installer">installer les “command line tools” ou un compilateur gcc</a> (pour pouvoir compiler des packages lorsque nécessaire)</li>
<li>Installer ensuite <a href="https://www.rstudio.com/products/rstudio/download/preview/">Rstudio</a></li>
</ul>
<div id="installation-du-tidyverse" class="section level2">
<h2><span class="header-section-number">4.1</span> Installation du tidyverse</h2>
<p>Qu’est ce que le <code>tidyverse</code> ?</p>
<ul>
<li>Le tidyverse est une suite de packages qui ont pour objet d’opérationnaliser le cycle d’analyse, depuis l’import des données jusqu’à leur représentation finale en passant par toute les étapes. Il a été développé par Hadley Wickham, connu essentiellement par son prénom dans la communauté (c’est un personnage important !). Parfois surnommé “hadleyverse” tant il est renommé, Hadley a demandé à ce qu’il soit nommé tidyverse pour valoriser la communauté et insister sur la notion de <em>tidy data</em>.<br />
</li>
<li>Liste des packages du tidyverse : broom, DBI, dplyr, forcats, ggplot2, haven, httr, hms, jsonlite, lubridate, magrittr, modelr, purrr, readr, readxl, stringr, tibble, rvest, tidyr, xml2 (<a href="https://cran.r-project.org/web/packages/tidyverse/index.html" class="uri">https://cran.r-project.org/web/packages/tidyverse/index.html</a>).</li>
<li>Pour installer le tidyverse, entrez dans la console : <code>install.packages(&quot;tidyverse&quot;)</code> puis appuyer sur entrée.
<ul>
<li>Si un warning s’affiche en précisant que le package n’est pas sous forme binaire, spécifier l’argument <code>type=&quot;source&quot;</code> dans l’appel à la fonction <code>install.packages()</code></li>
<li>Au passage, on voit que RStudio apporte une couche d’assistance en proposant les arguments de la fonction <code>install.packages</code></li>
<li>Si le bouton “Stop” (en haut à droite de la console de Rstudio) est affiché et que le symbole « &gt; » (invite de commande) n’est pas affiché, cela signifie que R continue de travailler.</li>
</ul></li>
<li>Quand c’est terminé on a le texte : *The downloaded binary packages are in C:_user_packages* (ou équivalent)</li>
<li>L’invite de commande est revenue : c’est ce symbole en début de ligne : « &gt; »</li>
<li>Il est également possible d’installer des packages individuellement via Rstudio (bouton Install à droite de l’IHM). Logique de R : tout peut être fait en lignes de commande.</li>
</ul>
</div>
<div id="lancement-du-tidyverse" class="section level2">
<h2><span class="header-section-number">4.2</span> Lancement du tidyverse :</h2>
<ul>
<li>Taper library(tidyverse), R Studio propose tidyverse. Si la console affiche des conflits, ne pas en tenir compte (tidyverse informe simplement à titre préventif).</li>
</ul>
</div>
</div>
<div id="vocabulaire-de-r" class="section level1">
<h1><span class="header-section-number">5</span> Vocabulaire de R</h1>
<ul>
<li><em>Package</em> = bouts de code stockés sur le disque dur. Si on veut utiliser fonctions de ces packages, on va charger les packages : R va lire le code qui est contenu dans le package. Le code des packages est approuvé par la communauté avec des contrôles de qualité automatisés pour vérifier leur fonctionnement. De plus en plus de packages ne sont pas publiés sur CRAN (officiel) mais passent par Github où il n’y a pas le contrôle qualité (démarche entièrement “libre”).</li>
<li><em>Logiciel interprété</em> : chaque ligne de commande est exécutée séquentiellement. On envoie une ligne de commande, l’ordinateur l’interprète et l’éxécute. Après, on peut reprendre la main.</li>
<li><code>library</code> permet de charger en mémoire un package et rendre disponible les fonctions.</li>
<li><em>Environnement</em> : tous les objets que nous allons utiliser dans R.</li>
<li>L’historique reprend les différentes instructions qui ont été tapés dans le terminal.</li>
<li>Script : fichier texte ave des instructions pour R.</li>
</ul>
</div>
<div id="commandes-de-r" class="section level1">
<h1><span class="header-section-number">6</span> Commandes de R</h1>
<p>Tout ce qu’on utilise dans R : des fonctions et des données</p>
<ul>
<li><code>library</code> : chargement d’un packages</li>
<li><code>rm</code> : suppression d’un objet</li>
<li><code>glimpse</code> : pré-visualiser un jeu de données</li>
</ul>
</div>
<div id="interface-de-r-studio" class="section level1">
<h1><span class="header-section-number">7</span> Interface de R Studio</h1>
<ul>
<li>La console (généralement en bas à gauche) : fenêtre essentielle, exactement la même chose que si vous le lanciez dans un Terminal (en tapant R en ligne de commande), l’interface basique pour échanger avec un ordinateur. Le terminal permet de taper du texte et de voir la réponse de l’ordinateur.</li>
<li>Possibilité de changer les couleurs de l’interface de R Studio : aller dans onglet Options/Apparences.</li>
<li>Global Environment (en haut à droite) &gt; contient tous les objets /fonctions que l’on va utiliser dans R</li>
<li>L’onglet “Packages” (en bas à droite) contient la liste de tous les packages installés, et permet d’en installer d’autres. On peut voir ceux qui sont chargés (cochés) et ceux qui ne le sont pas (case vide)</li>
<li>Onglet History (en haut à droite) : historique des commandes exécutées (historique recherchable, ce qui facilite la récupération d’anciennes commandes)</li>
<li>Onglet Files (en bas à droite) qui est un explorateur de fichiers de l’ordinateur. Par défaut, affiche le chemin du dossier de travail (working directory), le dossier du disque dur dans lequel R travaille.<br />
</li>
<li>Plots (en bas à droite) : Affiche les graphiques</li>
<li>L’onglet Help (en bas à droite) sert à rechercher toutes les fonctions documentées sur lesquelles on trouve un premier niveau d’aide. Documentation donne les arguments possibles de chaque package ou programmeet décrit le fonctionnement de ces arguments avec des exemples d’appels de fonctions .</li>
<li>Onglet Viewer (en vas à droite) : permet de visualiser les pages HTML et Javascript.</li>
</ul>
</div>
<div id="scripts-et-projets-sur-r" class="section level1">
<h1><span class="header-section-number">8</span> Scripts et projets sur R</h1>
<ul>
<li>Ajout d’un nouveau script : bouton en haut à droite avec la petite croix &gt; Add a R script.
<ul>
<li>Bonne pratique : Ne jamais écrire dans la console (pour ne pas perdre l’historique de mes actions).</li>
</ul></li>
<li>Le script contient de la colaration syntaxique qui permet de mieux comprendre son code.</li>
<li>Bonne pratique : une nouvelle ligne = une nouvelle instruction</li>
<li><p>Il y a des packages de données, entrer <code>library(airlines)</code> dans le script par exemple.</p></li>
<li><p>Les scripts s’enregistrent et se sauvegardent mais contrairement à la console, il ne se passe rien directement.</p></li>
<li><p><code>library(tidyverse)</code> dans le script et appuyer sur ctrl-entrée (Windows, Linux) ou pomme-entrée (Mac). Possibilité aussi d’appuyer sur le bouton Run =&gt; exécute l’instruction (ligne par ligne).</p></li>
<li>Projet dans RStudio : crée un environnement dédié dans lequel on a les données, les scripts, l’historique.
<ul>
<li>Bonne pratique : travailler toujours dans un projet puisque c’est uniquement dans un “projet” qu’on pourra avoir un historique</li>
</ul></li>
<li>“New directory” : on définit le répertoire dans lequel les différents éléments du projet (scripts, fonctions, données) seront stockés</li>
<li>“Existing directory” : ouvrir un projet déjà existant</li>
<li>“Version control” : suivre méthodiquement en comparant les différentes versions successives des fichiers textes. L’outil le plus répandu pour ça pour Git. Plateforme la plus connue : github (mais Dropbox fait du controle de version). Controle de version n’écrase pas les versions, en cas d’accident, on peut revenir en arrière : tous les états successifs sont stockés. Les projets peuvent être collaboratifs, on peut documenter qui a fait quoi, qui a écrit telle ligne et permet de créditer les contributeurs.
<ul>
<li>Bonne pratique : soumettre son code à un versioning. Une sauvegarde s’appelle un “Commit”. On peut commenter les versions pour suivre l’évolution du projet</li>
</ul></li>
<li><p>Possibilité de créer directement à partir d’un dossier Github. 1 - Aller sur une page Github &gt; Cliquer sur “Clone or Download” &gt; Copie de l’URL. 2- Aller sur R, ouvrir un Nouveau projet &gt; Controle de version et coller cette URL</p></li>
</ul>
<p>Controle de version : inclut une gestion des droits, avec un clone je ne peux pas écrire sauf si sur Github ou Gitlab le propriétaire donne des droits d’écriture. Possibilité de pull request (proposer une modification au propriétaire du dossier Git).</p>
<ul>
<li>Créer un nouveau projet, 3 options:
<ul>
<li><pre><code> Empty &gt; faire un nouveau projet vide</code></pre></li>
<li><pre><code> R Package  &gt; écrire un package</code></pre></li>
<li><pre><code> Shiny Web Application &gt; une app automatique</code></pre></li>
</ul></li>
<li>On crée un nouveau projet
<ul>
<li>En haut à droite, cliquer sur new project</li>
<li>Empty project</li>
<li>Donner un nom au directory (ex. jour 2) puis indiquer où placer de dossier sur le disque dur</li>
</ul></li>
<li>Si on veut travailler sur 2 projets en parallèle:
<ul>
<li>Cliquer sur “Open in New Session”</li>
</ul></li>
</ul>
<div id="creer-un-notebook" class="section level2">
<h2><span class="header-section-number">8.1</span> Créer un Notebook</h2>
<p>️Disponible uniquement dans la preview de <a href="https://www.rstudio.com/products/rstudio/download/preview">RStudio</a> (beta mais stable)</p>
<ul>
<li>Dans le panneau de script, il est possible d’ouvrir un <a href="http://rmarkdown.rstudio.com/r_notebooks.html">notebook</a> afin de visualiser les résultats des commandes dans le script même.</li>
<li>Notebook : avoir du texte, avec du code dedans et le résultat du code (généré à la volée)</li>
<li>A priori, les notebooks ne sont pour l’instant disponibles que dans la version Preview (version beta mais stable dans la mesure où elle est rendue disponible)</li>
<li>Bien adapté pour faire une analyse interactive.</li>
<li>Différent d’un script où il n’y a que du code R</li>
</ul>
</div>
<div id="creer-un-r-markdown" class="section level2">
<h2><span class="header-section-number">8.2</span> Créer un R Markdown</h2>
<ul>
<li>Markdown: un langage, une syntaxe qui fait une mise en forme minimaliste d’un texte (gras, italique etc..)</li>
<li><a href="http://daringfireball.net/projects/markdown/syntax">Guide de la syntaxe Markdown</a></li>
<li>Très léger, simple, puissant car peut générer dess documents dans <a href="http://rmarkdown.rstudio.com/formats.html">plein de formats</a></li>
<li><p>RMarkdown : permet de prévoir la mise en page du résultat final sous la forme soit d’une page web soit d’un fichier PDF (demande l’installation de Latex sur sa machine mais pas besoin de connaitre le langage). Très pratique pour générer directement le résultat de son travail.</p></li>
<li>Pour l’installer, on peut passer par le gestionnaire de packages.️ Installer <code>rmarkdown</code> et non <code>markdown</code></li>
<li>Avec RMarkdown, je peux générer des documents, des présentations, des applications interactives avec Shiny</li>
<li><p>Il existe des templates R Markdown, soit des modules prédéfinis. Ce sont des packages à installer, de la même manière que <code>tidyverse</code> par exemple.</p></li>
</ul>
</div>
<div id="creation-dun-script" class="section level2">
<h2><span class="header-section-number">8.3</span> Création d’un script</h2>
<ul>
<li>Commentaires : la ligne est préfixée par <code>#</code>
<ul>
<li>Bonne pratique : essentiel de documenter le plus explicitement possible et le plus abondamment possible</li>
<li>On peut aller jusqu’à une ligne de commentaires par ligne de code</li>
</ul></li>
<li>Il est tout à fait possible de se laisser guider par les suggestions de fonctions de Rstudio.
<ul>
<li>Exemple: si on tape “lib”, l’outil nous suggère “library” avec les arguments nécessaires. , en popup.</li>
<li>Bien regarder les valeurs par défaut dans la popup!</li>
</ul></li>
<li><p>Auto-complétion avec Tab ou Entrée</p></li>
<li>Dans <code>R</code>, 2 catégories d’êtres :
<ul>
<li>Objet: stocker “quelque chose”</li>
<li>Fonction : agissent sur des objets , à partir d’inputs produit des outputs
<ul>
<li>Chaque fonction produit une valeur (elle répond par un objet). Les inputs sont les arguments d’une fonction.</li>
<li>Parfois une fonction ne renvoit pas forcément de résultat ou de valeur, mais elle produit un effet de bord, par exemple, quand on charge un package.</li>
</ul></li>
</ul></li>
</ul>
<p>Ex. : <code>library</code>, on voit s’afficher les arguments dans une petite fenêtre qui s’affiche. Quand il y a une valeur, c’est une valeur par défaut (ils sont implicites, à moins de vouloir les modifier). Certains sont obligatoires : pour library, c’est le nom du package.</p>
<ul>
<li>2 types de problèmes possibles au cours de l’exécution du code :
<ul>
<li>Le <code>warning</code> n’arrête pas l’exécution du code.</li>
<li><code>error</code> : arrête l’exécution du code.</li>
</ul></li>
<li><p>Autant que possible, évitons de les rencontrer.</p></li>
<li><p>Donc dans <code>library</code>, on met l’argument <code>tidyverse</code>. On écrit dans le script : <code>library(tidyverse)</code>.</p></li>
<li>La console affiche des messages (c’est en rouge mais pas de problème, incohérence de R…).</li>
<li><p>On a pas besoin d’écrire <code>&quot;tidyverse&quot;</code> avec les guillemets. R a été fait pour des usagers sans forte compétence technique. La bonne pratique aurait été de mettre des guillemets car c’est un argument de type chaine de caractères.</p></li>
</ul>
</div>
</div>
<div id="importer-des-donnees" class="section level1">
<h1><span class="header-section-number">9</span> Importer des données</h1>
<div id="sur-le-format-csv" class="section level2">
<h2><span class="header-section-number">9.1</span> Sur le format CSV</h2>
<ul>
<li>CSV est venu des pratiques &gt; différentes interprétations.</li>
<li>Il n’est pas forcément lisible par le logiciel… &gt; nettoyage</li>
<li>Principes de base d’un fichier CSV : c’est un fichier texte</li>
<li>Les sauts de ligne sont matérialisés par des sauts de ligne (<code>\n</code>)</li>
<li>Chaque valeur est séparée par des virgules dans les pays anglo-saxons (parce qu’ils utilisent le “.” (point) pour séparer les valeurs numériques)</li>
<li><p>Le séparateur en France est le point virgule.</p></li>
<li>Bonne pratiques :
<ul>
<li>Nom des colonnes sur la 1ère ligne.</li>
<li>Mettre le texte entre guillemets –&gt; HYPER IMPORTANT pour signifier que c’est du texte et non des valeurs numériques
<ul>
<li>Cas de la corse : codes départements interprétés comme valeurs numériques… mais le logiciel affiche “erreur” une fois arrivé à la Corse (2A, 2B)</li>
</ul></li>
<li>Les cellules fusionnées sont à gérer comme des cellules vides, comme les commentaires</li>
<li>Voir le <a href="http://fr.slideshare.net/christophelibertidf/bonnes-pratiquesexcel-cc27juin2013">guide de Christophe Libert sur les fichiers CSV</a></li>
</ul></li>
<li>Il existe différentes propositions de standardisation (RFC 4180 est un standard CSV proposé)</li>
<li>La norme ASCII existe pour les caractères latins mais sans accents. Le RFC 4180 l’utilise</li>
<li>Norme unicode : permet d’avoir les accents. Excel l’utilise par défaut (ouas, ça dépend des OS !)</li>
<li>Libre Office gère plus facilement les fichiers avec des points virgule.</li>
<li>Passer d’un Excel à un CSV ne garantie pas une standardisation du CSV.</li>
<li>Un fichier CSV n’est pas forcément lisible par les machines</li>
<li>Mais on a des <a href="https://csvlint.io/">outils de validation du CSV</a></li>
<li>Dans les méta-données, on devrait signaler l’encodage et le caractère de séparation.</li>
<li>Peu de fichiers sont très bien expliqués (avec description des colonnes).</li>
<li><p>Tendance : faire des meta-données qui s’interprètent automatiquement (lisibles par une machine). Avoir les métadonnées permettrait d’avoir une bonne auto interprétation d’un fichier.</p></li>
</ul>
</div>
<div id="avec-linterface-graphique" class="section level2">
<h2><span class="header-section-number">9.2</span> Avec l’interface graphique</h2>
<ul>
<li>Dans le panel ‘environnement’ &gt; Pour charger des données, il faut aller sur “import dataset” et choisir le fichier qui nous intéresse : soit sur le disque car on avait prévu l’affaire au préalable, soit en ligne en indiquant l’URL.</li>
<li>R supporte les fichiers CSV, les fichiers Excel (xls et xlsx), Stata, SPSS. Pas LibreOffice (ods).</li>
<li>Si le fichier que l’on importe a les données séparées par des ; au lieu de , il faut aller dans la boite de dialogue Delimiter et sélectionner semicolon au lieu de comma et tout de suite ça ressemble à quelque chose.</li>
<li>Attention, ️Excel pose des problèmes d’encodage avec les fichiers CSV. Ne sauvegarde pas forcément en UTF8 par défaut et n’indique pas au début du fichier comment est encodé. Quand le producteur de données a utilisé Excel pour faire son CSV, il peut y avoir des bugs. Il vaut mieux alors ouvrir le fichier dans LibreOffice et exporter en CSV (LibreOffice fait du CSV propre, lui).</li>
<li>️Beaucoup de fichiers CSV français ou francophones sont séparés par des points virgule.</li>
</ul>
</div>
<div id="en-ligne-de-commandes" class="section level2">
<h2><span class="header-section-number">9.3</span> En ligne de commandes</h2>
<div id="ouvrir-le-fichier" class="section level3">
<h3><span class="header-section-number">9.3.1</span> Ouvrir le fichier</h3>
<p>Interface graphique propose très peu de fonctions, notamment sur la localisation des fichiers. En ligne de commande, on peut tout paramétrer.</p>
<ul>
<li>Spécifier les options d’import du fichier (encodage, caractère délimiteur, …).</li>
<li>L’interface de Rstudio ne propose qu’un nb restreint d’encodage. Pour spécifier tous les types d’encodage, privilégier le script</li>
<li>Pour ouvrir un fichier CSV dans le script : <code>read_csv</code> (du package <code>readr</code>) : séparateur <code>,</code> “anglosaxon” ou <code>read_csv2</code> : séparateur <code>;</code> “francophone”</li>
</ul>
<p>Ex:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">read_csv2</span>(<span class="st">&quot;URL&quot;</span>, <span class="dt">locale =</span> <span class="kw">locale</span>(<span class="dt">decimal_mark =</span> <span class="st">&quot;,&quot;</span>))</code></pre></div>
<ul>
<li>Pour la définition de l’opérateur décimal : <code>locale = locale(decimal_mark = &quot;,&quot;)</code> ou “.” selon le fichier
<ul>
<li>Astuce : On peut s’appuyer sur l’aide de R pour trouver les arguments de <code>read_csv2</code> (rappel : aller dans help et chercher le nom de la fonction en haut à droite, c’est à dire <code>read_csv2</code>)</li>
</ul></li>
<li>Il existe une librairie - un package - simple qui s’appelle <code>rio</code> [qu’il faut télécharger: <code>install.packages(&quot;rio&quot;)</code> / <code>library(rio)</code> ] et qui simplifie certaines fonctions, comme l’import.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw">import</span>(<span class="st">&quot;nom fichier&quot;</span>, <span class="dt">setclass =</span> <span class="st">&quot;tbl_df&quot;</span>)</code></pre></div>
<ul>
<li>Cette fonction “import” automatise la façon avec laquelle les colonnes sont parsées.</li>
</ul>
</div>
<div id="assigner-les-donnees" class="section level3">
<h3><span class="header-section-number">9.3.2</span> Assigner les données</h3>
<ul>
<li>Opérateur d’assignation : prend un objet et le stocke dans la mémoire. On pourra le récupérer et le travailler . Il faut indiquer <code>&lt;-</code> et le lier à la fonction de lecture des données <code>read_csv2</code>
<ul>
<li>Astuce : pour que longueur de la ligne s’adapte à la taille de la fenêtre, on va dans les préférences / code / “Soft-Wrap R Sources Files”</li>
</ul></li>
<li>On entre dans le script le nom de l’objet auquel veut assigner la valeur puis <code>&lt;-</code> puis la fonction et remplir les arguments :</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">monjeudedonnees &lt;-<span class="st"> </span><span class="kw">read_csv2</span>(<span class="st">&quot;http://www.ideeslibres.org/opendata/elus_municipaux_2008-2014/prenoms.csv&quot;</span>)</code></pre></div>
<pre><code>Parsed with column specification:
cols(
  prenom = col_character(),
  genre = col_character(),
  nb = col_integer()
)</code></pre>
</div>
<div id="specifier-les-colonnes" class="section level3">
<h3><span class="header-section-number">9.3.3</span> Spécifier les colonnes</h3>
<p>On exécute le code pour voir comment R interprète le fichier CSV. Dans la console, s’affichent les erreurs d’interprétation. Ces erreurs vont nous aider à mieux comprendre comment spécifier son jeu de données.</p>
<p>Dans la console, on voit s’afficher un extrait des premières lignes du jeu de données et la manière dont R a interprété le type de valeurs.</p>
<ul>
<li>Il existe plusieurs types de valeurs:
<ul>
<li><code>character</code> : chaîne de caractères</li>
<li><code>integer</code> : nombre entier (important pour préserver la mémoire)</li>
<li><code>numeric</code> : entier ou décimal</li>
<li><code>double</code> : nombre décimal</li>
</ul></li>
<li>Il est important de les spécifier pour indiquer à R comment interpréter chaque colonne au mieux suivant leurs spécificités.</li>
<li><p>Quand on ne sait pas, on dit que ce sont des characters.</p></li>
<li><p>Exemple si on veut spécifier qu’une colonne est une chaîne de caractères:</p></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">read_csv2</span>(<span class="st">&quot;monfichier.csv&quot;</span>, <span class="dt">col_types =</span> <span class="kw">cols</span>(<span class="dt">colonne_nomA_avec_du_texte =</span> <span class="kw">col_character</span>(), 
    <span class="dt">colonne_nomB_Avec_nombres_decimaux =</span> <span class="kw">col_double</span>(), <span class="dt">colonne_nomC_avec_des_nombres_entiers =</span> <span class="kw">col_integer</span>()))</code></pre></div>
<p>Nombre entier (<code>integer</code>) : besoin de moins d’espace pour les stocker Nombre décimal (<code>double</code>) : prend plus d’espace pour la mémoire car plus de diversité</p>
<p>Dans le cas du jeu de données sur les prénoms, on a le code suivant :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">monjeudedonnees &lt;-<span class="st"> </span><span class="kw">read_csv2</span>(<span class="st">&quot;http://www.ideeslibres.org/opendata/elus_municipaux_2008-2014/prenoms.csv&quot;</span>, 
    <span class="dt">col_types =</span> <span class="kw">cols</span>(<span class="dt">prenom =</span> <span class="kw">col_character</span>(), <span class="dt">genre =</span> <span class="kw">col_character</span>(), <span class="dt">nb =</span> <span class="kw">col_integer</span>()))</code></pre></div>
<p>Parser = prendre une suite d’éléments et les rendre interprétables. R parse le fichier automatiquement. Il faut l’intégrer dans le script pour avoir une bonne documentation qui permettra la reproductibilité du travail.</p>
</div>
</div>
</div>
<div id="afficher-les-donnees" class="section level1">
<h1><span class="header-section-number">10</span> Afficher les données</h1>
<p>Une fois que le fichier est importé, on peut visualiser le résultats dans le panneau Environnement:</p>
<ul>
<li>Visualisation des données (en cliquant sur le petit tableau à droite du nom de l’objet)</li>
<li>Information sur le nombre de lignes, colonnes, taille</li>
<li>Possibilité de trier les lignes dans la visualisation</li>
<li>“Ouverture” de la table (flèche bleue) pour voir le contenu (variable, type …)</li>
<li>L’explorateur d’Environnement sert à avoir une premier preview des données</li>
</ul>
<p>Dans le script : exécuter le nom de données. Dans notre cas, <code>monjeudedonnees</code> et le lancer.</p>
<p>Un “tibble” : un format de jeu de données qui permet notamment un affichage “propre” à l’écran :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">monjeudedonnees</code></pre></div>
<pre><code># A tibble: 12,467 × 3
        prenom genre    nb
         &lt;chr&gt; &lt;chr&gt; &lt;int&gt;
1       Michel     M 14136
2        Alain     M 10646
3     Philippe     M  9903
4      Bernard     M  8992
5    Christian     M  8102
6       Daniel     M  7821
7       Gérard     M  7009
8  Jean-Pierre     M  6945
9      Patrick     M  6884
10      Pierre     M  6711
# ... with 12,457 more rows</code></pre>
<p>Pour chaque type de donnée, R sait comment l’afficher (dans la console), grâce à la méthode <code>print</code>.</p>
</div>
<div id="sauvegarder-des-donnees" class="section level1">
<h1><span class="header-section-number">11</span> Sauvegarder des données ?</h1>
<p>Sauvegarder permet de garder les données qui sont en mémoire .</p>
<p>À la fermeture de la session, R par défaut propose d’enregistrer les objets en mémoire. Mauvaise pratique car ne met pas à jour les données et ne permet pas de retrouver les données.</p>
<p>Fonction : <code>save(nom_du_jeu_de_données,  fichier = &quot;./nom_du_jeu_de_données.Rdata&quot;)</code></p>
<p>Le 2è argument est le chemin où on veut sauvegarder le jeu de données.</p>
<p>Les fichiers Rdata sont des binaires compressés, bcp plus léger qu’xls ou CSV. Sur des très gros fichiers, peut être utile.</p>
<p>Bonne pratique : sauvegarder un fichier par jeu de données.</p>
<p>Pratique ++ : recréer le jeu de données depuis le script.</p>
<p>Pour lire un fichier Rdata = fonction <code>load</code> (symétrique de save) Exemple: <code>load(&quot;./nom_du_fichier.Rdata&quot;)</code></p>
<p>Avec Tab, on peut visualiser les arguments de la fonction et les fichiers disponibles dans l’arborescence.</p>
<blockquote>
<p>️Pas d’obligation de nommer les arguments… si on les enregistre dans l’ordre prévu dans l’aide ou dans la documentation en surimpression de la fonction.</p>
</blockquote>
<p>Dans l’aide, on peut savoir les arguments obligatoires : ils n’ont pas de valeurs par défaut. Ex pour <code>load</code> :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">load</span>(file, <span class="dt">envir =</span> <span class="kw">parent.frame</span>(), <span class="dt">verbose =</span> <span class="ot">FALSE</span>)  <span class="co"># file est un argument obligatoire car n&#39;a pas de valeur par défaut</span></code></pre></div>
<p>Attention, ️il faut sauvegarder son script sinon on perd tout. Faire Ctrl-S (Windows, Linux ou Pomme-S) et enregistrer le script.</p>
</div>
<div id="nettoyer-les-donnees---tidy-data" class="section level1">
<h1><span class="header-section-number">12</span> Nettoyer les données - tidy data</h1>
<div id="les-principes" class="section level2">
<h2><span class="header-section-number">12.1</span> Les principes</h2>
<blockquote>
<p>“Happy families are all alike; every unhappy family is unhappy in its own way.” – Leo Tolstoy<em> “Tidy datasets are all alike, but every messy dataset is messy in its own way.” – Hadley Wickham</em></p>
</blockquote>
<ul>
<li>À chaque variable sa propre colonne</li>
<li>À chaque observation sa propre ligne</li>
<li>À chaque valeur sa propre cellule &gt; 1 jeu de données par table, dite “tibble”</li>
</ul>
</div>
<div id="cas-pratique" class="section level2">
<h2><span class="header-section-number">12.2</span> Cas pratique</h2>
<ul>
<li>Executer le code suivant :</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">P2012T1 &lt;-<span class="st"> </span><span class="kw">read_csv2</span>(<span class="st">&quot;https://www.dropbox.com/s/6qc3nnsiohei6f2/presidentielle2012T1.csv?raw=1&quot;</span>, 
    <span class="dt">col_types =</span> <span class="kw">cols</span>(<span class="st">`</span><span class="dt">Code du département</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_character</span>(), <span class="st">`</span><span class="dt">Libellé du département</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_character</span>(), 
        <span class="st">`</span><span class="dt">Code de la commune</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_character</span>(), <span class="st">`</span><span class="dt">Libellé de la commune</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_character</span>(), 
        <span class="dt">Inscrits =</span> <span class="kw">col_integer</span>(), <span class="dt">Abstentions =</span> <span class="kw">col_integer</span>(), <span class="st">`</span><span class="dt">% Abs/Ins</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), 
        <span class="dt">Votants =</span> <span class="kw">col_integer</span>(), <span class="st">`</span><span class="dt">% Vot/Ins</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">Blancs et nuls</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% BlNuls/Ins</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% BlNuls/Vot</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), Exprimé<span class="dt">s =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Exp/Ins</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Exp/Vot</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe =</span> <span class="kw">col_logical</span>(), 
        <span class="dt">Nom =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom =</span> <span class="kw">col_character</span>(), <span class="dt">Voix =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_1 =</span> <span class="kw">col_logical</span>(), 
        <span class="dt">Nom_1 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_1 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_1 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_1</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_1</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_2 =</span> <span class="kw">col_character</span>(), 
        <span class="dt">Nom_2 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_2 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_2 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_2</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_2</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_3 =</span> <span class="kw">col_character</span>(), 
        <span class="dt">Nom_3 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_3 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_3 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_3</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_3</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_4 =</span> <span class="kw">col_character</span>(), 
        <span class="dt">Nom_4 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_4 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_4 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_4</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_4</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_5 =</span> <span class="kw">col_logical</span>(), 
        <span class="dt">Nom_5 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_5 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_5 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_5</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_5</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_6 =</span> <span class="kw">col_character</span>(), 
        <span class="dt">Nom_6 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_6 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_6 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_6</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_6</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_7 =</span> <span class="kw">col_character</span>(), 
        <span class="dt">Nom_7 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_7 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_7 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_7</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_7</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_8 =</span> <span class="kw">col_character</span>(), 
        <span class="dt">Nom_8 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_8 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_8 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_8</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_8</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="dt">Sexe_9 =</span> <span class="kw">col_character</span>(), 
        <span class="dt">Nom_9 =</span> <span class="kw">col_character</span>(), Pré<span class="dt">nom_9 =</span> <span class="kw">col_character</span>(), <span class="dt">Voix_9 =</span> <span class="kw">col_integer</span>(), 
        <span class="st">`</span><span class="dt">% Voix/Ins_9</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">`</span><span class="dt">% Voix/Exp_9</span><span class="st">`</span> =<span class="st"> </span><span class="kw">col_double</span>()))</code></pre></div>
<pre><code>Warning: Duplicated column names deduplicated: &#39;Sexe&#39; =&gt; &#39;Sexe_1&#39; [22],
&#39;Nom&#39; =&gt; &#39;Nom_1&#39; [23], &#39;Prénom&#39; =&gt; &#39;Prénom_1&#39; [24], &#39;Voix&#39; =&gt;
&#39;Voix_1&#39; [25], &#39;% Voix/Ins&#39; =&gt; &#39;% Voix/Ins_1&#39; [26], &#39;% Voix/Exp&#39; =&gt;
&#39;% Voix/Exp_1&#39; [27], &#39;Sexe&#39; =&gt; &#39;Sexe_2&#39; [28], &#39;Nom&#39; =&gt; &#39;Nom_2&#39; [29],
&#39;Prénom&#39; =&gt; &#39;Prénom_2&#39; [30], &#39;Voix&#39; =&gt; &#39;Voix_2&#39; [31], &#39;% Voix/Ins&#39; =&gt;
&#39;% Voix/Ins_2&#39; [32], &#39;% Voix/Exp&#39; =&gt; &#39;% Voix/Exp_2&#39; [33], &#39;Sexe&#39; =&gt;
&#39;Sexe_3&#39; [34], &#39;Nom&#39; =&gt; &#39;Nom_3&#39; [35], &#39;Prénom&#39; =&gt; &#39;Prénom_3&#39; [36], &#39;Voix&#39;
=&gt; &#39;Voix_3&#39; [37], &#39;% Voix/Ins&#39; =&gt; &#39;% Voix/Ins_3&#39; [38], &#39;% Voix/Exp&#39; =&gt;
&#39;% Voix/Exp_3&#39; [39], &#39;Sexe&#39; =&gt; &#39;Sexe_4&#39; [40], &#39;Nom&#39; =&gt; &#39;Nom_4&#39; [41],
&#39;Prénom&#39; =&gt; &#39;Prénom_4&#39; [42], &#39;Voix&#39; =&gt; &#39;Voix_4&#39; [43], &#39;% Voix/Ins&#39; =&gt;
&#39;% Voix/Ins_4&#39; [44], &#39;% Voix/Exp&#39; =&gt; &#39;% Voix/Exp_4&#39; [45], &#39;Sexe&#39; =&gt;
&#39;Sexe_5&#39; [46], &#39;Nom&#39; =&gt; &#39;Nom_5&#39; [47], &#39;Prénom&#39; =&gt; &#39;Prénom_5&#39; [48], &#39;Voix&#39;
=&gt; &#39;Voix_5&#39; [49], &#39;% Voix/Ins&#39; =&gt; &#39;% Voix/Ins_5&#39; [50], &#39;% Voix/Exp&#39; =&gt;
&#39;% Voix/Exp_5&#39; [51], &#39;Sexe&#39; =&gt; &#39;Sexe_6&#39; [52], &#39;Nom&#39; =&gt; &#39;Nom_6&#39; [53],
&#39;Prénom&#39; =&gt; &#39;Prénom_6&#39; [54], &#39;Voix&#39; =&gt; &#39;Voix_6&#39; [55], &#39;% Voix/Ins&#39; =&gt;
&#39;% Voix/Ins_6&#39; [56], &#39;% Voix/Exp&#39; =&gt; &#39;% Voix/Exp_6&#39; [57], &#39;Sexe&#39; =&gt;
&#39;Sexe_7&#39; [58], &#39;Nom&#39; =&gt; &#39;Nom_7&#39; [59], &#39;Prénom&#39; =&gt; &#39;Prénom_7&#39; [60], &#39;Voix&#39;
=&gt; &#39;Voix_7&#39; [61], &#39;% Voix/Ins&#39; =&gt; &#39;% Voix/Ins_7&#39; [62], &#39;% Voix/Exp&#39; =&gt;
&#39;% Voix/Exp_7&#39; [63], &#39;Sexe&#39; =&gt; &#39;Sexe_8&#39; [64], &#39;Nom&#39; =&gt; &#39;Nom_8&#39; [65],
&#39;Prénom&#39; =&gt; &#39;Prénom_8&#39; [66], &#39;Voix&#39; =&gt; &#39;Voix_8&#39; [67], &#39;% Voix/Ins&#39; =&gt;
&#39;% Voix/Ins_8&#39; [68], &#39;% Voix/Exp&#39; =&gt; &#39;% Voix/Exp_8&#39; [69], &#39;Sexe&#39; =&gt;
&#39;Sexe_9&#39; [70], &#39;Nom&#39; =&gt; &#39;Nom_9&#39; [71], &#39;Prénom&#39; =&gt; &#39;Prénom_9&#39; [72], &#39;Voix&#39;
=&gt; &#39;Voix_9&#39; [73], &#39;% Voix/Ins&#39; =&gt; &#39;% Voix/Ins_9&#39; [74], &#39;% Voix/Exp&#39; =&gt; &#39;%
Voix/Exp_9&#39; [75]</code></pre>
<ul>
<li>R va automatiquement dédupliquer les noms des colonnes de ce jeu de données “sale”.
<ul>
<li>Info : en cas de souci d’exécution d’une fonction, il est conseillé de sélectionner la totalité de l’appel à la fonction et de faire un CTRL + Entrée</li>
</ul></li>
<li>Pour de gros jeux de données avec beaucoup de colonnes, <code>glimpse</code> (dans tidyverse) permet d’afficher en long toutes les colonnes et de prévisualiser leur contenu : afficher le jeu de données <code>glimpse(P2012T1)</code>. &gt; l’intérêt c’est de l’afficher en long au lieu de l’afficher en large, du coup on voit les 1res lignes de toutes les variables en s’adaptant à la taille de l’écran.</li>
</ul>
</div>
<div id="preparer-des-tidy-data" class="section level2">
<h2><span class="header-section-number">12.3</span> Préparer des tidy data</h2>
<ul>
<li>Packages utiles pour faire du “tidy” data : <code>dplyr</code> et <code>tidyr</code>
<ul>
<li>Ce qui n’est pas utile dans le script, peut être mis en commentaires. Permet de tout rééexecuter sans lancer des fonctions inutiles et sans perdre la trace de leur utilité.</li>
<li>Ces packages travaillent tous avec des données tabulaires avec une syntaxe unifiée : des verbes.</li>
</ul></li>
<li>Ces verbes sont articulés avec un “pipe”, un tuyau et si on les mets bout à bout, cela donne un pipeline :)
<ul>
<li>Le symbole <code>%&gt;%</code> représente le pipe dans R (raccourci clavier pour l’écrire dans Rstudio : Ctrl + Shift + M ou Pomme + Shift + M)</li>
<li>L’intérêt c’est de se débarrasser des colonnes inutiles, ou plutôt de ne conserver que celles dont on a besoin</li>
</ul></li>
<li>Avec <code>select</code> : on indique les colonnes qu’on veut garder et celles dont on veut se débarrasser</li>
</ul>
<p>Colonnes pas utiles : libellé du département (on pourra les retrouver, redondant avec code du département), nom de la commune (redondant avec code de la commune), blancs et nuls (on pourra le recalculer)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">P2012T1 %&gt;%<span class="st"> </span><span class="kw">select</span>(<span class="st">`</span><span class="dt">Code du département</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Code de la commune</span><span class="st">`</span>, Inscrits, Votants, 
    Exprimés, <span class="kw">contains</span>(<span class="st">&quot;Voix&quot;</span>))</code></pre></div>
<pre><code># A tibble: 36,791 × 35
   `Code du département` `Code de la commune` Inscrits Votants Exprimés
                   &lt;chr&gt;                &lt;chr&gt;    &lt;int&gt;   &lt;int&gt;    &lt;int&gt;
1                      1                    1      592     508      499
2                      1                    2      215     179      174
3                      1                    4     8205    6507     6381
4                      1                    5     1152     982      964
5                      1                    6      105      88       87
6                      1                    7     1702    1480     1451
7                      1                    8      549     481      474
8                      1                    9      269     229      225
9                      1                   10      681     582      570
10                     1                   11      255     225      218
# ... with 36,781 more rows, and 30 more variables: Voix &lt;int&gt;, `%
#   Voix/Ins` &lt;dbl&gt;, `% Voix/Exp` &lt;dbl&gt;, Voix_1 &lt;int&gt;, `%
#   Voix/Ins_1` &lt;dbl&gt;, `% Voix/Exp_1` &lt;dbl&gt;, Voix_2 &lt;int&gt;, `%
#   Voix/Ins_2` &lt;dbl&gt;, `% Voix/Exp_2` &lt;dbl&gt;, Voix_3 &lt;int&gt;, `%
#   Voix/Ins_3` &lt;dbl&gt;, `% Voix/Exp_3` &lt;dbl&gt;, Voix_4 &lt;int&gt;, `%
#   Voix/Ins_4` &lt;dbl&gt;, `% Voix/Exp_4` &lt;dbl&gt;, Voix_5 &lt;int&gt;, `%
#   Voix/Ins_5` &lt;dbl&gt;, `% Voix/Exp_5` &lt;dbl&gt;, Voix_6 &lt;int&gt;, `%
#   Voix/Ins_6` &lt;dbl&gt;, `% Voix/Exp_6` &lt;dbl&gt;, Voix_7 &lt;int&gt;, `%
#   Voix/Ins_7` &lt;dbl&gt;, `% Voix/Exp_7` &lt;dbl&gt;, Voix_8 &lt;int&gt;, `%
#   Voix/Ins_8` &lt;dbl&gt;, `% Voix/Exp_8` &lt;dbl&gt;, Voix_9 &lt;int&gt;, `%
#   Voix/Ins_9` &lt;dbl&gt;, `% Voix/Exp_9` &lt;dbl&gt;</code></pre>
<ul>
<li><code>select_if</code> permet de ne sélectionner que les colonnes qui répondent à une condition (dans notre cas, sélectionner les colonnes où il y a le mot “voix” dedans)
<ul>
<li>L’idée c’est de créer une fonction pour réaliser cela.</li>
</ul></li>
<li>On regarde l’aide de <code>select_if</code></li>
<li>Dans l’aide, lire l’exemple peut aider pour formuler sa fonction</li>
<li>On va créer une fonction anonyme qui n’est pas déclarée à l’avance. Si je l’utilise plusieurs fois, il faudrait la créer à part. Dans R, c’est courant ; dans d’autres langages, moins.</li>
<li><p><code>grepl</code> : fonction logique qui checke si oui ou non il y a une certaine chaine de caractères</p></li>
<li>On sélectionne les colonnes avec juste le nom des candidats
<ul>
<li>On sélectionne juste la première ligne ( <code>slice(1)</code> )</li>
<li>Une fois qu’on a cette petite fonction, on la stocke pour pouvoir la réutiliser</li>
</ul></li>
<li><code>names(df)</code> = le nom de toutes les variables
<ul>
<li>l’ordre des colonnes compte, il faut les compter (pardon du jeu de mots)</li>
</ul></li>
<li><code>names(df)[6:15]</code> = ça veut dire = on prend le nom des colonnes de 6 à 15
<ul>
<li>Dès qu’on sélectionne et exécute un bout de code comme <code>names(df)[6:15]</code>, ça affiche le contenu dans la console</li>
</ul></li>
<li>L’idée c’est de les remplacer par par les noms qu’on a envie d’afficher.</li>
<li>Ce qu’on cherche à faire c’est de transformer le tableau/matrice avec les noms qui existe en un “vecteur”
<ul>
<li>Mettre des éléments les uns à la suite des autres = vectoriser</li>
<li>Si les données sont bidimensionnelles (ex. noms et années), une matrice</li>
</ul></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## on ne garde que les colonnes de nom

noms &lt;-<span class="st"> </span>P2012T1 %&gt;%<span class="st"> </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;Nom&quot;</span>))

## on ne garde que la première ligne

noms &lt;-<span class="st"> </span>noms %&gt;%<span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span>)

## On transforme en vecteur
noms &lt;-<span class="st"> </span><span class="kw">as.vector</span>(<span class="kw">t</span>(noms))

## on ne garde que les colonnes utiles

df &lt;-<span class="st"> </span>P2012T1 %&gt;%<span class="st"> </span><span class="kw">select</span>(<span class="st">`</span><span class="dt">Code du département</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Code de la commune</span><span class="st">`</span>, Inscrits, 
    Votants, Exprimés, <span class="kw">starts_with</span>(<span class="st">&quot;Voix&quot;</span>))

## on change les noms des colonnes pour y mettre le nom des candidats
<span class="kw">names</span>(df)[<span class="dv">6</span>:<span class="dv">15</span>] &lt;-<span class="st"> </span>noms

<span class="kw">glimpse</span>(df)</code></pre></div>
<pre><code>Observations: 36,791
Variables: 15
$ Code du département &lt;chr&gt; &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1...
$ Code de la commune  &lt;chr&gt; &quot;1&quot;, &quot;2&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;1...
$ Inscrits            &lt;int&gt; 592, 215, 8205, 1152, 105, 1702, 549, 269,...
$ Votants             &lt;int&gt; 508, 179, 6507, 982, 88, 1480, 481, 229, 5...
$ Exprimés            &lt;int&gt; 499, 174, 6381, 964, 87, 1451, 474, 225, 5...
$ JOLY                &lt;int&gt; 13, 10, 124, 16, 3, 26, 8, 5, 7, 4, 4, 2, ...
$ LE PEN              &lt;int&gt; 126, 38, 1359, 238, 25, 330, 112, 40, 155,...
$ SARKOZY             &lt;int&gt; 159, 45, 1603, 323, 19, 371, 109, 69, 130,...
$ MÉLENCHON           &lt;int&gt; 25, 15, 778, 57, 9, 190, 51, 33, 68, 34, 4...
$ POUTOU              &lt;int&gt; 2, 2, 83, 6, 1, 10, 8, 4, 4, 2, 2, 0, 12, ...
$ ARTHAUD             &lt;int&gt; 2, 0, 41, 6, 1, 12, 0, 1, 6, 0, 3, 0, 6, 1...
$ CHEMINADE           &lt;int&gt; 2, 1, 21, 0, 0, 5, 1, 2, 1, 1, 1, 0, 6, 1,...
$ BAYROU              &lt;int&gt; 54, 22, 543, 97, 8, 141, 55, 27, 47, 22, 1...
$ DUPONT-AIGNAN       &lt;int&gt; 4, 2, 138, 26, 0, 34, 5, 6, 15, 6, 2, 2, 3...
$ HOLLANDE            &lt;int&gt; 112, 39, 1691, 195, 21, 332, 125, 38, 137,...</code></pre>
<p>C’est du tidy data, répond aux conditions de Wickham : chaque colonne correspond à une variable et chaque ligne correspond à une observation. Plus restrictif que des données tabulaires.</p>
<p>Quand on a du tidy data, c’est plus facile de visualiser des données. Les packages les interprètent plus facilement.</p>
<p>On peut avec R et <a href="http://shiny.rstudio.com">shiny</a> créer une interface qui permet au public novice de transformer des données sans lancer R.</p>
<blockquote>
<p>Outil développé par Joël Gombin pour transformer automatiquement les fichiers électoraux du ministère de l’intérieur : <a href="https://github.com/joelgombin/LireMinInterieur" class="uri">https://github.com/joelgombin/LireMinInterieur</a></p>
</blockquote>
</div>
</div>
<div id="transformer-les-donnees" class="section level1">
<h1><span class="header-section-number">13</span> Transformer les données</h1>
<ul>
<li>On va prendre le code de département
<ul>
<li>stringr : transformer des chaines de caractères</li>
</ul></li>
<li>On veut rajouter un zéro à gauche (“padder”) pour les codes de département soient standardisés sur deux nombres car les codes insee sont de 5 caractères, les deux premiers le département et les trois suivants sont ceux de la commune</li>
<li>Dans les données, il faut utiliser le code INSEE plutôt que le code postal –&gt; en France, le code postal correspond à plusieurs communes (ex. 89250 : Mont Saint Sulpice et Seignelay), et une commune peut avoir plusieurs codes postaux.</li>
<li><p>On va utiliser la fonction <code>mutate</code></p></li>
<li>On crée une nouvelle variable qui s’appelle <code>CodeDpt</code> (Code département)</li>
<li>Et on utilise <code>str_pad</code> qui permet de rajouter des caractères quand il en manque
<ul>
<li>Voir l’aide, Plusieurs arguments :
<ul>
<li><code>string</code>: la variable de départ</li>
<li><code>width</code> : la largeur minimale qu’on veut obtenir</li>
<li><code>side</code> : où rajouter le caractère manquant</li>
<li><code>pad</code> : que rajouter quand il manque des caractères, en l’occurence “0”</li>
</ul></li>
</ul></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(stringr)
df %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">codedpt =</span> <span class="kw">str_pad</span>(<span class="st">`</span><span class="dt">Code du département</span><span class="st">`</span>, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="dv">0</span>))</code></pre></div>
<pre><code># A tibble: 36,791 × 16
   `Code du département` `Code de la commune` Inscrits Votants Exprimés
                   &lt;chr&gt;                &lt;chr&gt;    &lt;int&gt;   &lt;int&gt;    &lt;int&gt;
1                      1                    1      592     508      499
2                      1                    2      215     179      174
3                      1                    4     8205    6507     6381
4                      1                    5     1152     982      964
5                      1                    6      105      88       87
6                      1                    7     1702    1480     1451
7                      1                    8      549     481      474
8                      1                    9      269     229      225
9                      1                   10      681     582      570
10                     1                   11      255     225      218
# ... with 36,781 more rows, and 11 more variables: JOLY &lt;int&gt;, `LE
#   PEN` &lt;int&gt;, SARKOZY &lt;int&gt;, MÉLENCHON &lt;int&gt;, POUTOU &lt;int&gt;,
#   ARTHAUD &lt;int&gt;, CHEMINADE &lt;int&gt;, BAYROU &lt;int&gt;, `DUPONT-AIGNAN` &lt;int&gt;,
#   HOLLANDE &lt;int&gt;, codedpt &lt;chr&gt;</code></pre>
<ul>
<li>On refait la même chose pour les codes des communes en 3 chiffres pour être conforme à la norme INSEE :</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">CodeCommune =</span> <span class="kw">str_pad</span>(<span class="st">&quot;Code de la commune&quot;</span>, <span class="dv">3</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>))</code></pre></div>
<pre><code># A tibble: 36,791 × 16
   `Code du département` `Code de la commune` Inscrits Votants Exprimés
                   &lt;chr&gt;                &lt;chr&gt;    &lt;int&gt;   &lt;int&gt;    &lt;int&gt;
1                      1                    1      592     508      499
2                      1                    2      215     179      174
3                      1                    4     8205    6507     6381
4                      1                    5     1152     982      964
5                      1                    6      105      88       87
6                      1                    7     1702    1480     1451
7                      1                    8      549     481      474
8                      1                    9      269     229      225
9                      1                   10      681     582      570
10                     1                   11      255     225      218
# ... with 36,781 more rows, and 11 more variables: JOLY &lt;int&gt;, `LE
#   PEN` &lt;int&gt;, SARKOZY &lt;int&gt;, MÉLENCHON &lt;int&gt;, POUTOU &lt;int&gt;,
#   ARTHAUD &lt;int&gt;, CHEMINADE &lt;int&gt;, BAYROU &lt;int&gt;, `DUPONT-AIGNAN` &lt;int&gt;,
#   HOLLANDE &lt;int&gt;, CodeCommune &lt;chr&gt;</code></pre>
<ul>
<li>Au final, on crée un pipe et on regarde le résultat avec la fonction <code>glimpse</code> :</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">codedpt =</span> <span class="kw">str_pad</span>(<span class="st">`</span><span class="dt">Code du département</span><span class="st">`</span>, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="dv">0</span>)) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">codecommune =</span> <span class="kw">str_pad</span>(<span class="st">`</span><span class="dt">Code de la commune</span><span class="st">`</span>, <span class="dv">3</span>, <span class="st">&quot;left&quot;</span>, <span class="dv">0</span>))

df %&gt;%<span class="st"> </span><span class="kw">glimpse</span>()</code></pre></div>
<pre><code>Observations: 36,791
Variables: 17
$ Code du département &lt;chr&gt; &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1&quot;, &quot;1...
$ Code de la commune  &lt;chr&gt; &quot;1&quot;, &quot;2&quot;, &quot;4&quot;, &quot;5&quot;, &quot;6&quot;, &quot;7&quot;, &quot;8&quot;, &quot;9&quot;, &quot;1...
$ Inscrits            &lt;int&gt; 592, 215, 8205, 1152, 105, 1702, 549, 269,...
$ Votants             &lt;int&gt; 508, 179, 6507, 982, 88, 1480, 481, 229, 5...
$ Exprimés            &lt;int&gt; 499, 174, 6381, 964, 87, 1451, 474, 225, 5...
$ JOLY                &lt;int&gt; 13, 10, 124, 16, 3, 26, 8, 5, 7, 4, 4, 2, ...
$ LE PEN              &lt;int&gt; 126, 38, 1359, 238, 25, 330, 112, 40, 155,...
$ SARKOZY             &lt;int&gt; 159, 45, 1603, 323, 19, 371, 109, 69, 130,...
$ MÉLENCHON           &lt;int&gt; 25, 15, 778, 57, 9, 190, 51, 33, 68, 34, 4...
$ POUTOU              &lt;int&gt; 2, 2, 83, 6, 1, 10, 8, 4, 4, 2, 2, 0, 12, ...
$ ARTHAUD             &lt;int&gt; 2, 0, 41, 6, 1, 12, 0, 1, 6, 0, 3, 0, 6, 1...
$ CHEMINADE           &lt;int&gt; 2, 1, 21, 0, 0, 5, 1, 2, 1, 1, 1, 0, 6, 1,...
$ BAYROU              &lt;int&gt; 54, 22, 543, 97, 8, 141, 55, 27, 47, 22, 1...
$ DUPONT-AIGNAN       &lt;int&gt; 4, 2, 138, 26, 0, 34, 5, 6, 15, 6, 2, 2, 3...
$ HOLLANDE            &lt;int&gt; 112, 39, 1691, 195, 21, 332, 125, 38, 137,...
$ codedpt             &lt;chr&gt; &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, ...
$ codecommune         &lt;chr&gt; &quot;001&quot;, &quot;002&quot;, &quot;004&quot;, &quot;005&quot;, &quot;006&quot;, &quot;007&quot;, ...</code></pre>
<ul>
<li>Avantage de R : Une ligne de code pour résoudre ce problème</li>
</ul>
<p>/!\ ️C’est important de faire <code>df &lt;- df %&gt;% ...</code> pour stocker (assigner) le résultat</p>
<ul>
<li>Maintenant qu’on a normalisé les codes commune et codes département, on peut créer un un code Insee</li>
<li>Fait de coller ensemble = une concaténation</li>
<li>Dans R, s’appelle <code>paste</code> : coller (facile !). Il y a deux fonctions : paste (met un espace par défaut) et paste0 (sans espace par défaut)</li>
<li>Le code à mettre est :</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">CodeInsee =</span> <span class="kw">paste0</span>(codedpt, codecommune))

<span class="co"># on se débarasse des variables devenues inutiles</span>
df &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span><span class="kw">select</span>(-<span class="st">`</span><span class="dt">Code du département</span><span class="st">`</span>, -<span class="st">`</span><span class="dt">Code de la commune</span><span class="st">`</span>)</code></pre></div>
<ul>
<li>De plus on sélectionne ce qui nous intéresse et on lui dit avec le moins les colonnes qu’il doit retirer.</li>
<li>Reste à assigner.</li>
</ul>
<div id="un-autre-exemple" class="section level2">
<h2><span class="header-section-number">13.1</span> Un autre exemple</h2>
<p>Travaillons sur le jeu de données portant sur <a href="https://frama.link/reserve">la réserve parlementaire</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
reserve &lt;-<span class="st"> </span><span class="kw">read_csv2</span>(<span class="st">&quot;./reserve-assemblee-2013.csv&quot;</span>, <span class="dt">col_types =</span> <span class="kw">cols</span>(<span class="dt">ID_SUBVENTION =</span> <span class="kw">col_integer</span>(), 
    <span class="dt">NOM_BENEFICIAIRE =</span> <span class="kw">col_character</span>(), <span class="dt">DESCRIPTION_SUBVENTION =</span> <span class="kw">col_character</span>(), 
    <span class="dt">ADRESSE_BENEFICIAIRE =</span> <span class="kw">col_character</span>(), <span class="dt">PROGRAMME_PJL_FINANCE =</span> <span class="kw">col_character</span>(), 
    <span class="dt">MONTANT_SUBVENTION =</span> <span class="kw">col_integer</span>(), <span class="dt">PRENOM_NOM_DEPUTE_NOSDEPUTES =</span> <span class="kw">col_character</span>(), 
    <span class="dt">ID_DEPUTE_AN =</span> <span class="kw">col_character</span>(), <span class="dt">ID_NOSDEPUTES =</span> <span class="kw">col_integer</span>(), <span class="dt">NOM_DEPUTE_NOSDEPUTES =</span> <span class="kw">col_character</span>(), 
    <span class="dt">PRENOM_DEPUTE_NOSDEPUTES =</span> <span class="kw">col_character</span>(), <span class="dt">SEXE_DEPUTE =</span> <span class="kw">col_character</span>(), 
    <span class="dt">DATE_NAISSANCE_DEPUTE =</span> <span class="kw">col_date</span>(<span class="dt">format =</span> <span class="st">&quot;&quot;</span>), <span class="dt">LIEU_NAISSANCE_DEPUTE =</span> <span class="kw">col_character</span>(), 
    <span class="dt">ID_DEPARTEMENT =</span> <span class="kw">col_character</span>(), <span class="dt">DEPARTEMENT_NOSDEPUTES =</span> <span class="kw">col_character</span>(), 
    <span class="dt">NUMERO_CIRCONSCRIPTION =</span> <span class="kw">col_integer</span>(), <span class="dt">DATE_DEBUT_MANDAT =</span> <span class="kw">col_date</span>(<span class="dt">format =</span> <span class="st">&quot;&quot;</span>), 
    <span class="dt">DATE_FIN_MANDAT =</span> <span class="kw">col_date</span>(<span class="dt">format =</span> <span class="st">&quot;&quot;</span>), <span class="dt">MANDAT_CLOS =</span> <span class="kw">col_integer</span>(), <span class="dt">GROUPE_SIGLE =</span> <span class="kw">col_character</span>(), 
    <span class="dt">PARTI_RATTACHEMENT_FINANCIER =</span> <span class="kw">col_character</span>(), <span class="dt">PROFESSION =</span> <span class="kw">col_character</span>(), 
    <span class="dt">PLACE_HEMICYCLE =</span> <span class="kw">col_integer</span>(), <span class="dt">URL_DEPUTE_AN =</span> <span class="kw">col_character</span>(), <span class="dt">SLUG_NOSDEPUTES =</span> <span class="kw">col_character</span>(), 
    <span class="dt">URL_DEPUTE_NOSDEPUTES =</span> <span class="kw">col_character</span>(), <span class="dt">API_NOSDEPUTES =</span> <span class="kw">col_character</span>(), 
    <span class="dt">NB_MANDATS =</span> <span class="kw">col_integer</span>()))

<span class="kw">library</span>(stringr)

reserve &lt;-<span class="st"> </span>reserve %&gt;%<span class="st"> </span><span class="co"># création d&#39;un code circo sur deux caractères</span>
<span class="kw">mutate</span>(<span class="dt">CodeCirco =</span> <span class="kw">str_pad</span>(NUMERO_CIRCONSCRIPTION, <span class="dv">2</span>, <span class="st">&quot;left&quot;</span>, <span class="st">&quot;0&quot;</span>)) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">CodeCirco =</span> <span class="kw">paste</span>(ID_DEPARTEMENT, 
    CodeCirco, <span class="dt">sep =</span> <span class="st">&quot;-&quot;</span>))  <span class="co"># concaténation</span>

reserve</code></pre></div>
<pre><code># A tibble: 10,920 × 30
   ID_SUBVENTION
           &lt;int&gt;
1              1
2              2
3              3
4              4
5              5
6              6
7              7
8              8
9              9
10            10
# ... with 10,910 more rows, and 29 more variables:
#   NOM_BENEFICIAIRE &lt;chr&gt;, DESCRIPTION_SUBVENTION &lt;chr&gt;,
#   ADRESSE_BENEFICIAIRE &lt;chr&gt;, PROGRAMME_PJL_FINANCE &lt;chr&gt;,
#   MONTANT_SUBVENTION &lt;int&gt;, PRENOM_NOM_DEPUTE_NOSDEPUTES &lt;chr&gt;,
#   ID_DEPUTE_AN &lt;chr&gt;, ID_NOSDEPUTES &lt;int&gt;, NOM_DEPUTE_NOSDEPUTES &lt;chr&gt;,
#   PRENOM_DEPUTE_NOSDEPUTES &lt;chr&gt;, SEXE_DEPUTE &lt;chr&gt;,
#   DATE_NAISSANCE_DEPUTE &lt;date&gt;, LIEU_NAISSANCE_DEPUTE &lt;chr&gt;,
#   ID_DEPARTEMENT &lt;chr&gt;, DEPARTEMENT_NOSDEPUTES &lt;chr&gt;,
#   NUMERO_CIRCONSCRIPTION &lt;int&gt;, DATE_DEBUT_MANDAT &lt;date&gt;,
#   DATE_FIN_MANDAT &lt;date&gt;, MANDAT_CLOS &lt;int&gt;, GROUPE_SIGLE &lt;chr&gt;,
#   PARTI_RATTACHEMENT_FINANCIER &lt;chr&gt;, PROFESSION &lt;chr&gt;,
#   PLACE_HEMICYCLE &lt;int&gt;, URL_DEPUTE_AN &lt;chr&gt;, SLUG_NOSDEPUTES &lt;chr&gt;,
#   URL_DEPUTE_NOSDEPUTES &lt;chr&gt;, API_NOSDEPUTES &lt;chr&gt;, NB_MANDATS &lt;int&gt;,
#   CodeCirco &lt;chr&gt;</code></pre>
</div>
</div>
<div id="pivoter-gather-et-spread-du-package-tidyr" class="section level1">
<h1><span class="header-section-number">14</span> Pivoter (<code>gather</code> et <code>spread</code>, du package <code>tidyr</code>)</h1>
<ul>
<li>Pivoter un jeu de données
<ul>
<li>Format large : tableau avec beaucoup de colonnes, peu de lignes</li>
<li>Format long : tableau avec peu de colonnes et beaucoup de lignes</li>
</ul></li>
<li><code>gather</code> &gt; permet de passer d’un tableau large à un tableau en longueur</li>
<li><code>spread</code> &gt; permet de passer d’un tableau long à un tableau large
<ul>
<li>Ces deux fonctions font partie du package <code>tidyr</code>, lui même composante du <code>tidyverse</code>.</li>
</ul></li>
</ul>
<p>Stockage en format long (colonne) :</p>
<p><a href="http://r4ds.had.co.nz/tidy-data.html#gathering"><img src="img/tidy-9.png" /></a></p>
<p>Dans ce cas, format long : les dates peuvent être spécifiées comme telles. Format large : les dates deviennent des variables.</p>
<div id="cas-des-bureaux-de-votes-a-paris" class="section level2">
<h2><span class="header-section-number">14.1</span> Cas des bureaux de votes à Paris</h2>
<p>Format long : <a href="https://opendata.paris.fr/explore/dataset/resultats_electoraux/?disjunctive.libelle_du_scrutin">un résultat sur un PV de bureau de votes</a>, on peut le retravailler et agréger des lignes pour repasser en tableau large. Tableaux longs sont difficillement lisibles par l’usager lambda. Ce qui est considéré comme du tidy data dépend de la définition de ce qui est une observation et une variable : ça peut dépendre des usages.</p>
<p>Pour le producteur de données, format long privilégie les usagers techniques (dév). Format large privilégie les utilisateurs grand public, directement intelligible, plus facile de répérer l’information (pas besoin de faire des tris dans le tableur). Ouverture données brutes : penser d’abord à l’usage interne.</p>
</div>
<div id="exercice-avec-des-donnees-electorales" class="section level2">
<h2><span class="header-section-number">14.2</span> Exercice avec des données électorales</h2>
<p>On reprend les données électorales utilisées plus haut</p>
<div id="de-large-vers-long" class="section level3">
<h3><span class="header-section-number">14.2.1</span> De large vers long</h3>
<p>Pour aller de large vers Long, on utilise donc la fonction <code>gather</code> qui comporte 3 arguments: Ex: <code>gather(Candidat, Voix, JOLY:HOLLANDE)</code></p>
<p>1 - Candidat : Création d’une nouvelle colonne avec les noms des candidats 2 - Voix : La colonne dans laquelle on va stocker le nombre de voix 3 - Le périmètre des “candidats”. De Joly à Hollande.</p>
<p>L’opérateur &quot; : &quot; signifie de … à … Exemple: JOLY:HOLLANDE = prendre tout ce qu’il y a de Joly à Hollande</p>
<p>/!\ &gt; Il faudra créer de nouvelles variables, la création de la nouvelle variable (la colonne) conceptualise le contenu : ex les noms des candidats, cela devient un “candidat” et non une suite de nom et du coup ensuite on met dans cette colonne tous les candidats, de Joly à Hollande. C’est le plus compliqué : savoir ce que l’on veut rassembler et pour arriver à quel résultat.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">##### pivoter large/long et vice-versa

<span class="co"># large vers long</span>

df_long &lt;-<span class="st"> </span>df %&gt;%<span class="st"> </span><span class="kw">gather</span>(Candidat, Voix, JOLY:HOLLANDE)

df_long</code></pre></div>
<pre><code># A tibble: 367,910 × 8
   Inscrits Votants Exprimés codedpt codecommune CodeInsee Candidat  Voix
      &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;int&gt;
1       592     508      499      01         001     01001     JOLY    13
2       215     179      174      01         002     01002     JOLY    10
3      8205    6507     6381      01         004     01004     JOLY   124
4      1152     982      964      01         005     01005     JOLY    16
5       105      88       87      01         006     01006     JOLY     3
6      1702    1480     1451      01         007     01007     JOLY    26
7       549     481      474      01         008     01008     JOLY     8
8       269     229      225      01         009     01009     JOLY     5
 [ getOption(&quot;max.print&quot;) est atteint -- 2 lignes omises ]
# ... with 367,900 more rows</code></pre>
</div>
</div>
</div>
<div id="quelques-autres-fonctions-utiles" class="section level1">
<h1><span class="header-section-number">15</span> Quelques autres fonctions utiles</h1>
<p><code>arrange</code> fait partie du tidyverse et permet de trier par variable</p>
<p>Si on fait <code>df_long</code> c’est pour créer un nouveau tableau avec cette expérience et ne pas écraser le tableau original. Le DataFrame (<code>df_long</code>) a ce nouveau nom.</p>
<p>Question: comment on fait pour calculer un pourcentage ? En créant une nuovelle colonne: (<code>mutate</code>) Ex: <code>mutate(pourcent_ins = Voix / Inscrits * 100)</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_long %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(CodeInsee) %&gt;%<span class="st">  </span><span class="co">#les opérations qui suivent sont par commune</span>
<span class="st">  </span><span class="kw">arrange</span>(-Voix) %&gt;%<span class="st"> </span><span class="co">#on trie par ordre décroissant du nombre de voix dans chaque commune</span>
<span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span>:<span class="dv">2</span>) %&gt;%<span class="st"> </span><span class="co">#on ne garde que les deux premières lignes</span>
<span class="st">  </span>ungroup %&gt;%<span class="st"> </span><span class="co">#le reste se fait sur l&#39;ensemble de la table</span>
<span class="st">  </span><span class="kw">arrange</span>(-Inscrits) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="co">#tri sur l&#39;ensemble des inscrits </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pourcent_ins =</span> Voix /<span class="st"> </span>Inscrits *<span class="st"> </span><span class="dv">100</span>)</code></pre></div>
<pre><code># A tibble: 73,582 × 9
   Inscrits Votants Exprimés codedpt codecommune CodeInsee Candidat   Voix
      &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt;  &lt;int&gt;
1   1253322 1004567   992474      75         056     75056 HOLLANDE 345635
2   1253322 1004567   992474      75         056     75056  SARKOZY 319482
3    484206  378905   373704      13         055     13055 HOLLANDE 104818
4    484206  378905   373704      13         055     13055  SARKOZY 100637
5    292869  233328   230214      69         123     69123  SARKOZY  70311
6    292869  233328   230214      69         123     69123 HOLLANDE  69629
7    249386  193353   190711      31         555     31555 HOLLANDE  65689
8    249386  193353   190711      31         555     31555  SARKOZY  44092
 [ getOption(&quot;max.print&quot;) est atteint -- 2 lignes omises ]
# ... with 73,572 more rows, and 1 more variables: pourcent_ins &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># calculer le % des inscrits</span>

df_long &lt;-<span class="st"> </span>df_long %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">pourcent.ins =</span> Voix /<span class="st"> </span>Inscrits *<span class="st"> </span><span class="dv">100</span>)</code></pre></div>
<div id="de-long-vers-large" class="section level3">
<h3><span class="header-section-number">15.0.1</span> De long vers large</h3>
<p>Il est donc très courant de passer régulièrement de long en large et vice versa pour bénéficier des facilités de chaque mode pour travailler les données facilement.</p>
<p><code>spread</code> : 2 arguments = Nom des deux colonnes</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># long vers large</span>

df_large &lt;-<span class="st"> </span>df_long %&gt;%<span class="st"> </span><span class="kw">spread</span>(Candidat, Voix)

df_large</code></pre></div>
<pre><code># A tibble: 36,791 × 16
   Inscrits Votants Exprimés codedpt codecommune CodeInsee ARTHAUD BAYROU
*     &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;   &lt;int&gt;  &lt;int&gt;
1       592     508      499      01         001     01001       2     54
2       215     179      174      01         002     01002       0     22
3      8205    6507     6381      01         004     01004      41    543
4      1152     982      964      01         005     01005       6     97
5       105      88       87      01         006     01006       1      8
6      1702    1480     1451      01         007     01007      12    141
7       549     481      474      01         008     01008       0     55
8       269     229      225      01         009     01009       1     27
 [ getOption(&quot;max.print&quot;) est atteint -- 2 lignes omises ]
# ... with 36,781 more rows, and 8 more variables: CHEMINADE &lt;int&gt;,
#   `DUPONT-AIGNAN` &lt;int&gt;, HOLLANDE &lt;int&gt;, JOLY &lt;int&gt;, `LE PEN` &lt;int&gt;,
#   MÉLENCHON &lt;int&gt;, POUTOU &lt;int&gt;, SARKOZY &lt;int&gt;</code></pre>
</div>
<div id="filter-les-donnees" class="section level2">
<h2><span class="header-section-number">15.1</span> Filter les données</h2>
<p>Utile pour sélectionner des données dans certains cas.</p>
<p>Slice est utile mais limité, il y a donc une autre fonction <code>filter</code> qui est plus large dans son action et utile pour travailler sur un sous ensemble du jeu de données. Ce filtre prend 1 (en l’occurence) argument logique : fait ou ne fait pas partie de la condition. dans l’exemple : une commune fait ou ne fait pas partie de la région souhaitée. on utilise donc le code du département. On utilise un opérateur d’appartenance à un ensemble.</p>
<p>Opérateur d’égalité : <code>==</code> mais fastidieux</p>
<p><code>c()</code> designe les vecteurs dans R.</p>
<p>(on trouve la liste des raccourcis clavier dans le menu “Help” &gt; “keyboards shortcuts” et qui renvoie à une page complète)</p>
<div id="exercice-filtrer-par-les-communes-de-la-region-idf" class="section level3">
<h3><span class="header-section-number">15.1.1</span> Exercice: Filtrer par les communes de la Region IDF</h3>
<p>Nouvel opérateur: <code>%in%</code>, vérifie que les éléments à sa gauche appartiennent à l’ensemble qui se situe à sa droite. Permet de spécifier un certain périmètre. Bonne pratique : systématiquement remplacer <code>==</code> par <code>%in%</code> car l’opérateur <code>==</code> ne sait pas gérer les valeurs manquantes (<code>NA</code>), contrairement au <code>%in%</code></p>
<p>Dans notre cas, le filtre porte sur tous les départements d’IDF.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_idf &lt;-<span class="st"> </span>df_long %&gt;%<span class="st"> </span><span class="co"># ne garder que les lignes des départements d&#39;Ile-de-France %in% est un</span>
<span class="co"># opérateur</span>
<span class="kw">filter</span>(codedpt %in%<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;75&quot;</span>, <span class="st">&quot;77&quot;</span>, <span class="st">&quot;78&quot;</span>, <span class="st">&quot;91&quot;</span>, <span class="st">&quot;92&quot;</span>, <span class="st">&quot;93&quot;</span>, <span class="st">&quot;94&quot;</span>, <span class="st">&quot;95&quot;</span>))

df_idf</code></pre></div>
<pre><code># A tibble: 12,810 × 9
   Inscrits Votants Exprimés codedpt codecommune CodeInsee Candidat  Voix
      &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;int&gt;
1   1253322 1004567   992474      75         056     75056     JOLY 41495
2       906     758      743      77         001     77001     JOLY    22
3       553     459      451      77         002     77002     JOLY     8
4       277     241      240      77         003     77003     JOLY     2
5       266     222      219      77         004     77004     JOLY     2
6      2059    1664     1640      77         005     77005     JOLY    36
7       663     540      534      77         006     77006     JOLY     8
8       273     243      242      77         007     77007     JOLY     9
 [ getOption(&quot;max.print&quot;) est atteint -- 2 lignes omises ]
# ... with 12,800 more rows, and 1 more variables: pourcent.ins &lt;dbl&gt;</code></pre>
</div>
<div id="exercice-filtrer-les-communes-des-bouches-du-rhone" class="section level3">
<h3><span class="header-section-number">15.1.2</span> Exercice : filtrer les communes des Bouches du Rhone</h3>
<p>Utiliser <code>%in%</code>, pas besoin de <code>c()</code>, car un seul département</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_bdr &lt;-<span class="st"> </span>df_long %&gt;%<span class="st"> </span><span class="co"># ne garder que les lignes des départements d&#39;Ile-de-France %in% est un</span>
<span class="co"># opérateur</span>
<span class="kw">filter</span>(codedpt %in%<span class="st"> &quot;13&quot;</span>)

df_bdr</code></pre></div>
<pre><code># A tibble: 1,190 × 9
   Inscrits Votants Exprimés codedpt codecommune CodeInsee Candidat  Voix
      &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;int&gt;
1     90437   71792    70824      13         001     13001     JOLY  2219
2     16629   14150    13873      13         002     13002     JOLY   252
3      1838    1581     1545      13         003     13003     JOLY    36
4     37292   29960    29430      13         004     13004     JOLY   600
5     32051   26048    25592      13         005     13005     JOLY   533
6      1215    1054     1035      13         006     13006     JOLY    34
7      8589    7310     7204      13         007     13007     JOLY   166
8       415     369      364      13         008     13008     JOLY    15
 [ getOption(&quot;max.print&quot;) est atteint -- 2 lignes omises ]
# ... with 1,180 more rows, and 1 more variables: pourcent.ins &lt;dbl&gt;</code></pre>
</div>
<div id="exercice-trouver-les-communes-qui-votent-le-plus-pour-hollande" class="section level3">
<h3><span class="header-section-number">15.1.3</span> Exercice : trouver les communes qui votent le plus pour Hollande</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_hollande &lt;-<span class="st"> </span>df_long %&gt;%<span class="st"> </span><span class="kw">filter</span>(Candidat %in%<span class="st"> &quot;HOLLANDE&quot;</span>)

df_hollande %&gt;%<span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(pourcent.ins))</code></pre></div>
<pre><code># A tibble: 36,791 × 9
   Inscrits Votants Exprimés codedpt codecommune CodeInsee Candidat  Voix
      &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;    &lt;chr&gt; &lt;int&gt;
1        31      27       27      11         093     11093 HOLLANDE    24
2        24      23       23      11         354     11354 HOLLANDE    18
3       417     348      346      2B         293     2B293 HOLLANDE   266
4       160     128      127      2B         195     2B195 HOLLANDE    97
5        77      68       67      32         225     32225 HOLLANDE    46
6        27      27       27      11         402     11402 HOLLANDE    16
7        27      24       24      24         384     24384 HOLLANDE    16
8        61      51       49      09         193     09193 HOLLANDE    36
 [ getOption(&quot;max.print&quot;) est atteint -- 2 lignes omises ]
# ... with 36,781 more rows, and 1 more variables: pourcent.ins &lt;dbl&gt;</code></pre>
<p>La fonction <code>arrange</code> trie le dataframe/tibble, ici par ordre décroissant du vote Hollande</p>
<p>Attention d’une manière générale, R est sensible à la casse, il faut bien écrire <code>&quot;HOLLANDE&quot;</code></p>
</div>
<div id="exercice-ne-conserver-que-les-communes-dans-lesquelles-le-pen-obtient-plus-de-20-des-inscrits" class="section level3">
<h3><span class="header-section-number">15.1.4</span> Exercice : ne conserver que les communes dans lesquelles Le Pen obtient plus de 20% des inscrits</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_lepenistes &lt;-<span class="st"> </span>df_large %&gt;%<span class="st">  </span><span class="co"># on crée un ensemble pour les communes &quot;lepenistes&quot; (hmm hmm)</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">LePen_ins =</span> <span class="st">`</span><span class="dt">LE PEN</span><span class="st">`</span> /<span class="st"> </span>Inscrits *<span class="st"> </span><span class="dv">100</span>) %&gt;%<span class="st"> </span><span class="co"># on calcule le pourcentage des inscrits qui ont voté Le Pen</span>
<span class="st">  </span><span class="kw">filter</span>(LePen_ins &gt;<span class="st"> </span><span class="dv">20</span>)

df_lepenistes</code></pre></div>
<pre><code># A tibble: 12,058 × 17
   Inscrits Votants Exprimés codedpt codecommune CodeInsee ARTHAUD BAYROU
      &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;   &lt;int&gt;  &lt;int&gt;
1       592     508      499      01         001     01001       2     54
2      1152     982      964      01         005     01005       6     97
3       105      88       87      01         006     01006       1      8
4       549     481      474      01         008     01008       0     55
5       681     582      570      01         010     01010       6     47
6       140     124      122      01         013     01013       0     18
7       813     669      663      01         022     01022       6     55
8        48      45       44      01         023     01023       0      3
 [ getOption(&quot;max.print&quot;) est atteint -- 2 lignes omises ]
# ... with 12,048 more rows, and 9 more variables: CHEMINADE &lt;int&gt;,
#   `DUPONT-AIGNAN` &lt;int&gt;, HOLLANDE &lt;int&gt;, JOLY &lt;int&gt;, `LE PEN` &lt;int&gt;,
#   MÉLENCHON &lt;int&gt;, POUTOU &lt;int&gt;, SARKOZY &lt;int&gt;, LePen_ins &lt;dbl&gt;</code></pre>
<p><code>&gt;</code> est un prédicat logique d’inégalité</p>
<p>quand la variable comporte un espace il est préférable de passer par l’autocomplétion, qui va ajouter des backticks (`LE PEN`) qui vont faire comprendre à R que c’est une seule expression.</p>
<p>Pour éviter de faire la même transformation colonne par colonne, on peut utiliser <code>mutate_each</code> qui applique la transformation à toutes les colonnes à la fois. on créé une fonction : <code>funs(. /Inscrits = 100)</code></p>
<p>le . indique que c’est générique. MMais on perd le nombre de voix car <code>mutate_each</code> remplace, écrase les données (ça va certainement évoluer pour éviter de perdre les données).</p>
<ul>
<li>vars permet d’indiquer les variables qu’on veut sélectionner</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_large %&gt;%<span class="st"> </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(ARTHAUD:SARKOZY), <span class="kw">funs</span>(./Inscrits *<span class="st"> </span><span class="dv">100</span>))</code></pre></div>
<pre><code># A tibble: 36,791 × 16
   Inscrits Votants Exprimés codedpt codecommune CodeInsee   ARTHAUD
      &lt;int&gt;   &lt;int&gt;    &lt;int&gt;   &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;     &lt;dbl&gt;
1       592     508      499      01         001     01001 0.3378378
2       215     179      174      01         002     01002 0.0000000
3      8205    6507     6381      01         004     01004 0.4996953
4      1152     982      964      01         005     01005 0.5208333
5       105      88       87      01         006     01006 0.9523810
6      1702    1480     1451      01         007     01007 0.7050529
7       549     481      474      01         008     01008 0.0000000
8       269     229      225      01         009     01009 0.3717472
9       681     582      570      01         010     01010 0.8810573
 [ getOption(&quot;max.print&quot;) est atteint -- ligne 1 omise ]
# ... with 36,781 more rows, and 9 more variables: BAYROU &lt;dbl&gt;,
#   CHEMINADE &lt;dbl&gt;, `DUPONT-AIGNAN` &lt;dbl&gt;, HOLLANDE &lt;dbl&gt;, JOLY &lt;dbl&gt;,
#   `LE PEN` &lt;dbl&gt;, MÉLENCHON &lt;dbl&gt;, POUTOU &lt;dbl&gt;, SARKOZY &lt;dbl&gt;</code></pre>
<p>Quand on fait un <code>spread</code>, il faut qu’il y ait qu’une seule colonne qui représente les valeurs uniques de chaque ligne. On ne peut pas avoir nombre de voix et score des inscrits, par exemple. Il faut donc enlever les pourcentages d’inscrits. Un tableau long doit avoir 3 colonnes sinon c’est large. Il faut avoir 3 colonnes pour faire un spread.</p>
<p>Le format long du jeu de données des élections a plus de colonnes que 3 mais ça reste un fichier long car les variables sont les mêmes pour chaque code Insee</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_large &lt;-<span class="st"> </span>df_long %&gt;%<span class="st"> </span><span class="kw">select</span>(-pourcent.ins) %&gt;%<span class="st"> </span><span class="kw">spread</span>(Candidat, Voix)</code></pre></div>
<p>Si 4 colonnes : faire un <code>gather</code></p>
<blockquote>
<p>Ce qu’il faut retenir :)</p>
<p>Le jeu de données initial pour faire un spread est de 3 colonnes. Un tableau en format long est un tableau de 3 colonnes MAXIMUM.</p>
</blockquote>
</div>
</div>
</div>
<div id="agreger-un-jeu-de-donnees-group_by-summarise" class="section level1">
<h1><span class="header-section-number">16</span> Agréger un jeu de données (<code>group_by</code> + <code>summarise</code>)</h1>
<p>On veut regrouper des observations par un ou plusieurs critères : c’est le rôle de la fonction <code>group_by</code></p>
<p>Exemple: agréger les résulats par département à partir du fichier par communes</p>
<p>Une option: Partir du format large (pour avoir une colonne par candidat) Pour chaque groupe, il faut générer une ligne unique Puis calcul du nombre d’inscrits par département</p>
<p>/!\ Quand on utilise <code>summarise</code> il faut toujours préciser les variables sur lesquelles on travaille sinon le résultat final présenté est tronqué</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_large %&gt;%<span class="st"> </span><span class="kw">group_by</span>(codedpt) %&gt;%<span class="st"> </span><span class="kw">summarise</span>(<span class="dt">Inscrits =</span> <span class="kw">sum</span>(Inscrits))</code></pre></div>
<pre><code># A tibble: 107 × 2
   codedpt Inscrits
     &lt;chr&gt;    &lt;int&gt;
1       01   393808
2       02   376068
3       03   256275
4       04   123933
5       05   106865
6       06   745288
7       07   243351
8       08   196579
9       09   116370
10      10   203590
# ... with 97 more rows</code></pre>
<ul>
<li>On perd des infos avec summarise. 2 options : -on refait la bascule format long / format large
<ul>
<li>on met plusieurs arguments pour summarise.</li>
</ul></li>
<li>Autre méthode: Pour chaque département avoir pour résultat final un tableau avec: total du nombre d’inscrits, d’exprimés, de votants, et de voix par candidats.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">df_large %&gt;%<span class="st"> </span><span class="kw">group_by</span>(codedpt) %&gt;%<span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(Inscrits, Exprimés, Votants, 
    ARTHAUD:SARKOZY), <span class="kw">funs</span>(<span class="kw">sum</span>(.)))</code></pre></div>
<pre><code># A tibble: 107 × 14
   codedpt Inscrits Exprimés Votants ARTHAUD BAYROU CHEMINADE
     &lt;chr&gt;    &lt;int&gt;    &lt;int&gt;   &lt;int&gt;   &lt;int&gt;  &lt;int&gt;     &lt;int&gt;
1       01   393808   321359  327812    1794  32650       860
2       02   376068   297944  303140    2490  19895       738
3       03   256275   205950  211009    1482  17814       457
4       04   123933   100788  102899     487   7483       283
5       05   106865    86777   88619     488   8559       212
6       06   745288   582842  591905    1576  38980      1238
7       07   243351   200718  204791    1257  18373       521
8       08   196579   153591  156071    1185  11551       366
9       09   116370    96048   97868     528   6411       221
 [ getOption(&quot;max.print&quot;) est atteint -- ligne 1 omise ]
# ... with 97 more rows, and 7 more variables: `DUPONT-AIGNAN` &lt;int&gt;,
#   HOLLANDE &lt;int&gt;, JOLY &lt;int&gt;, `LE PEN` &lt;int&gt;, MÉLENCHON &lt;int&gt;,
#   POUTOU &lt;int&gt;, SARKOZY &lt;int&gt;</code></pre>
<p><code>summarise_at</code> fonctionne comme <code>mutate_at</code> : on l’utilise pour appliquer le même traitement à plusieurs colonnes.</p>
</div>
<div id="fusionner-left_join" class="section level1">
<h1><span class="header-section-number">17</span> Fusionner (<code>left_join</code>)</h1>
<p>Intérêt de l’open data : rapprocher plusieurs fichiers entre eux.</p>
<p>Un <code>join</code>, c’est joindre plusieurs fichiers. Il y a plein de joins possibles.</p>
<p><code>left_join</code> : le plus utile et plus utilisé dans notre cas. Left : la table de gauche nous intéresse le plus et la table de droite va permettre de le compléter (ex : compléter avec une valeur issue de zones d’emplois), je veux attribuer à chaque commune une valeur de zone d’emplois.</p>
<ul>
<li>Reprendre le jeu de données “présidentielle”</li>
<li>Y adjoindre le code de la zone d’emploi de chaque commune (source : <a href="http://www.insee.fr/fr/methodes/default.asp?page=zonages/zones_emploi.htm" class="uri">http://www.insee.fr/fr/methodes/default.asp?page=zonages/zones_emploi.htm</a>) : <a href="https://frama.link/ze_csv" class="uri">https://frama.link/ze_csv</a></li>
</ul>
<p>Lorsque l’on veut joindre 2 fichiers entre eux, il faut spécifier quel est le fichier de base et celui que l’on ajoute pour enrichir le premier. Dans l’idée, on rajoute des colonnes sur la droite du fichier initial afin de l’enrichir. On ajoute les fichiers 1 par 1 même si on les chaine ensemble pour gagner du temps. Evidemment, il faut qu’il y ait un identifiant commun entre les 2 fichiers que l’on veut joindre, sinon ça peut pas marcher… cet identifiant commun doit être similaire mais pas forcément s’appeler pareil. On se retrouve donc avec un fichier avec toutes les colonnes du fichier initial + les colonnes du fichier supplémentaire. Pour limiter ça, on peut sélectionner les colonnes à ajouter par une fonction <code>select</code>.</p>
<p>Les zones d’emploi : bassins d’emploi homogènes, créés par l’INSEE. Chaque commune est rattachée à une zone d’emploi.</p>
<p>On veut rapprocher le code INSEE de la commune de celui de la zone d’emploi. On peut travailler tout autant avec le fichier large que le fichier long. On part du tableau large par facilité mais pas obligatoire.</p>
<p>On regarde la doc de <code>left_join</code> : l’argument qui fait la liaison c’est <code>by</code>. On fait un vecteur Code Insee (dans jeu élections) = Code Geo (dans jeu INSEE)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># on lit le fichier avec les codes des zones d&#39;emploi</span>
ze &lt;-<span class="st"> </span><span class="kw">read_csv2</span>(<span class="st">&quot;https://frama.link/ze_csv&quot;</span>)</code></pre></div>
<pre><code>Parsed with column specification:
cols(
  CODGEO = col_character(),
  LIBGEO = col_character(),
  ZE2010 = col_character(),
  LIBZE2010 = col_character(),
  DEP = col_character(),
  REG = col_integer(),
  REG2016 = col_integer()
)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># on le fusionne avec nos données</span>
df_large &lt;-<span class="st"> </span><span class="kw">left_join</span>(df_large, ze, <span class="dt">by =</span> <span class="kw">c</span>(<span class="dt">CodeInsee =</span> <span class="st">&quot;CODGEO&quot;</span>))

<span class="co"># à partir de là, on peut agréger les résultats par zone d&#39;emploi</span>
df_ze_lepen &lt;-<span class="st"> </span>df_large %&gt;%<span class="st"> </span><span class="kw">group_by</span>(LIBZE2010) %&gt;%<span class="st"> </span><span class="kw">summarise_at</span>(<span class="kw">vars</span>(Inscrits, 
    Exprimés, Votants, ARTHAUD:SARKOZY), <span class="kw">funs</span>(<span class="kw">sum</span>(.))) %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">LePen_ins =</span> <span class="st">`</span><span class="dt">LE PEN</span><span class="st">`</span>/Inscrits *<span class="st"> </span>
<span class="st">    </span><span class="dv">100</span>) %&gt;%<span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(LePen_ins))

df_ze_lepen</code></pre></div>
<pre><code># A tibble: 305 × 15
                          LIBZE2010 Inscrits Exprimés Votants ARTHAUD
                              &lt;chr&gt;    &lt;int&gt;    &lt;int&gt;   &lt;int&gt;   &lt;int&gt;
1                            Orange    66970    53870   54871     193
2                        Sarrebourg    55431    44065   45036     409
3  Vitry-le-François - Saint-Dizier    85190    66437   67682     523
4                     Sarreguemines    83490    64827   66275     629
5              Saint-Dié-des-Vosges    65445    51880   53023     413
6                      Lens - Hénin   264291   197496  201523    1775
7                           Péronne    42269    34090   34682     425
8                           Avignon   350697   283982  288949    1108
9                           Forbach   154340   116464  118527     939
10                         Commercy    32551    26602   27095     173
# ... with 295 more rows, and 10 more variables: BAYROU &lt;int&gt;,
#   CHEMINADE &lt;int&gt;, `DUPONT-AIGNAN` &lt;int&gt;, HOLLANDE &lt;int&gt;, JOLY &lt;int&gt;,
#   `LE PEN` &lt;int&gt;, MÉLENCHON &lt;int&gt;, POUTOU &lt;int&gt;, SARKOZY &lt;int&gt;,
#   LePen_ins &lt;dbl&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># on sauvegarde le résultat en CSV</span>
<span class="kw">write_excel_csv</span>(df_ze_lepen, <span class="dt">path =</span> <span class="st">&quot;./resultats_ze.csv&quot;</span>, <span class="dt">na =</span> <span class="st">&quot;&quot;</span>)</code></pre></div>
<p>À partir de là, on peut commencer à visualiser nos données (teaser de la deuxième partie de cette formation !)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Visualiser des données (teaser)</span>
df_large %&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">Abstention_ins =</span> (Inscrits -<span class="st"> </span>Votants)/Inscrits *<span class="st"> </span><span class="dv">100</span>) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> Abstention_ins)) +<span class="st"> </span><span class="kw">geom_histogram</span>() +<span class="st"> </span><span class="kw">theme_gray</span>()</code></pre></div>
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="index_files/figure-html/unnamed-chunk-29-1.png" width="768" /></p>
<div id="acceder-a-la-deuxieme-partie-de-cette-formation-utiliser-r-pour-lanalyse-et-la-visualisation-de-donnees" class="section level3">
<h3><span class="header-section-number">17.0.1</span> Accéder à la deuxième partie de cette formation, <a href="./index2.html">“Utiliser R pour l’analyse et la visualisation de données”</a></h3>
</div>
</div>
</div>


</div>

<div id="postamble" data-toggle="wy-nav-shift" class="status">
<p class="date"><span class="glyphicon glyphicon-calendar"></span> 17 au 19 octobre 2016</p>
</div>


<script>
$(document).ready(function () {
 	    $('#content img')
 	  .addClass("image-lb");
  $('#content').magnificPopup({
	      type:'image',
	      closeOnContentClick: false,
	      delegate: 'img',
	      gallery: {enabled: false },
	      image: {
	        verticalFit: true,
          titleSrc: 'alt'
	      }
 	    });
 	});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
